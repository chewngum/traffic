<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Labb - Two-Way Passing</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="/common.js"></script>
</head>
<body>
    <div id="loading" class="loading">
        <h2>Verifying access...</h2>
    </div>

    <div id="app" class="container hidden">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="header-title">
                    <h1>Two-Way Passing Simulation</h1>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="glass-card">
                <h3 class="section-title">Configuration</h3>
                
                <div class="cards-container">
                    <div class="card">
                        <div class="card-title">Traffic Flow</div>
                        <div style="background: #e3f1f7; padding: 12px; border-radius: 6px; margin-bottom: 12px; text-align: center; border: 1px solid #a3c9e0;">
                            <div style="font-size: 0.9rem; margin-bottom: 6px; font-weight: 600;">Traffic Directions</div>
                            <div style="font-size: 1.2rem; margin: 8px 0; color: #354e8d; font-weight: bold;">Queue A → ⟷ ← Queue B</div>
                            <div style="font-size: 0.8rem; color: #666;">Single Lane Road Segment</div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="arrivalRateA">Queue A Rate (cars/hr):</label>
                                <input type="number" id="arrivalRateA" value="15" min="0" step="0.1" onchange="validateAndUpdate('arrivalRateA', 0); calculateSampleSize(); updateRuntimeDisplay(); updateUtilizationEstimate()">
                            </div>
                            <div class="form-group">
                                <label for="arrivalRateB">Queue B Rate (cars/hr):</label>
                                <input type="number" id="arrivalRateB" value="15" min="0" step="0.1" onchange="validateAndUpdate('arrivalRateB', 0); calculateSampleSize(); updateRuntimeDisplay(); updateUtilizationEstimate()">
                            </div>
                        </div>
                        <div class="validation-check">
                            <strong>Total Arrival Rate:</strong> <span id="totalArrivalDisplay">30.0</span> cars/hr
                        </div>
                        <div class="validation-check utilization-check">
                            <strong>Estimated Utilization:</strong> <span id="utilizationEstimateDisplay">45.0%</span>
                        </div>
                        <div id="followUpWarning" class="utilization-warning" style="display: none;">
                            <span id="followUpMessage">Actual utilization will be slightly less due to follow-up time permitting additional efficiency</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Service Parameters</div>
                        <div class="form-group">
                            <label for="serviceMode">Service Time Mode:</label>
                            <select id="serviceMode" onchange="toggleServiceMode(); updateUtilizationEstimate()">
                                <option value="fixed" selected>Fixed Service Time</option>
                                <option value="speed">Distance + Speed</option>
                            </select>
                        </div>

                        <div id="fixedServiceGroup">
                            <div class="form-group">
                                <label for="serviceTime">Service Time (seconds):</label>
                                <input type="number" id="serviceTime" value="5.4" min="0.1" step="0.1" onchange="validateAndUpdate('serviceTime', 0.1); updateUtilizationEstimate()">
                            </div>
                        </div>

                        <div id="speedServiceGroup" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="segmentDistance">Distance (meters):</label>
                                    <input type="number" id="segmentDistance" value="30" min="0.1" step="0.1" onchange="validateAndUpdate('segmentDistance', 0.1); calculateServiceTime(); updateUtilizationEstimate()">
                                </div>
                                <div class="form-group">
                                    <label for="vehicleSpeed">Speed (km/h):</label>
                                    <input type="number" id="vehicleSpeed" value="20" min="0.1" step="0.1" onchange="validateAndUpdate('vehicleSpeed', 0.1); calculateServiceTime(); updateUtilizationEstimate()">
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="minGap">Min Gap Between Arrivals (s):</label>
                                <input type="number" id="minGap" value="0" min="0" step="0.1" onchange="validateAndUpdate('minGap', 0); updateUtilizationEstimate()">
                            </div>
                            <div class="form-group">
                                <label for="minFollowUp">Min Follow-up Time:</label>
                                <select id="minFollowUp" onchange="toggleCustomFollowUp(); updateUtilizationEstimate()">
                                    <option value="0">0 seconds</option>
                                    <option value="minGap">Same as min gap</option>
                                    <option value="serviceTime" selected>Same as service time</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" id="customFollowUpGroup" style="display: none;">
                            <label for="customFollowUp">Custom Follow-up (seconds):</label>
                            <input type="number" id="customFollowUp" value="2" min="0" max="60" step="0.1" onchange="validateAndUpdate('customFollowUp', 0, 60); updateUtilizationEstimate()">
                            <div class="help-text">Custom follow-up time</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Simulation Settings</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="simulationHours">Simulation Hours:</label>
                                <input type="number" id="simulationHours" value="1000" min="10" max="50000" step="10" onchange="validateAndUpdate('simulationHours', 1, 50000); calculateSampleSize(); updateRuntimeDisplay()">
                            </div>
                            <div class="form-group">
                                <label for="priorityScheme">Priority Scheme:</label>
                                <select id="priorityScheme">
                                    <option value="A">Queue A Priority</option>
                                    <option value="B">Queue B Priority</option>
                                    <option value="FCFS" selected>First Come First Served</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="numSeeds">Number of Seeds:</label>
                                <input type="number" id="numSeeds" value="130" min="1" max="10000" step="1" onchange="validateAndUpdate('numSeeds', 1, 10000); updateRuntimeDisplay(); calculateSampleSize()">
                            </div>
                            <div class="form-group">
                                <label for="seedMode">Seed Mode:</label>
                                <select id="seedMode">
                                    <option value="fixed" selected>Fixed (Reproducible)</option>
                                    <option value="random">Random</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Estimated Runtime:</label>
                            <div id="runtimeEstimate" class="help-text" style="font-weight: 600;">Calculating...</div>
                        </div>
                    </div>

                    <div class="card sample-calculator">
                        <div class="card-title">Sample Size Calculator</div>
                        <p style="margin-bottom: 6px; font-size: 0.85rem; color: #666;">Calculate minimum seeds for statistical confidence</p>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="confidenceLevel">Confidence Level (%):</label>
                                <input type="number" id="confidenceLevel" value="99.9" min="85" max="99.99" step="0.01" onchange="validateAndUpdate('confidenceLevel', 85, 99.99); calculateSampleSize()">
                            </div>
                            <div class="form-group">
                                <label for="marginError">Margin (trips/hour):</label>
                                <input type="number" id="marginError" value="0.05" min="0.001" step="0.001" onchange="validateAndUpdate('marginError', 0.001); calculateSampleSize()">
                            </div>
                        </div>
                        
                        <div id="sampleSizeResult" class="sample-result">
                            Calculating minimum seeds...
                        </div>

                        <div class="sample-actions">
                            <button id="applySampleSize" class="btn-apply-sample">
                                Use Recommended Seeds
                            </button>
                            <div class="current-seeds-info">
                                Current: <span id="currentSeedsDisplay">130</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="buttons-row">
                    <button class="btn btn-reset" id="resetButton">Reset</button>
                    <button class="btn btn-run" id="runSimulation">Run Simulation</button>
                </div>
                
                <div class="status" id="status" style="display: none;"></div>
                <div class="progress-bar" id="progressContainer" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text">
                        <div id="progressPercentage">0%</div>
                        <div id="progressDetails">Initializing...</div>
                    </div>
                </div>
            </div>
            
            <div class="results-container" id="resultsSection">
                <h3 class="section-title">Results</h3>
                
                <div id="resultsContent">
                    <div class="no-results">
                        <h4>Results will appear here</h4>
                        <p>Configure parameters and run simulation to see averaged results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .sample-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: center;
        }

        .btn-apply-sample {
            background: #6b99c2;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            flex: 1;
            max-width: 150px;
        }

        .btn-apply-sample:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-apply-sample:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .sample-result {
            padding: 12px;
            border: 2px solid #a3c9e0;
            border-radius: 6px;
            background: rgba(163, 201, 224, 0.1);
            text-align: center;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }

        .current-seeds-info {
            font-size: 0.75rem;
            color: #666;
            text-align: right;
            flex: 1;
        }

        #currentSeedsDisplay {
            font-weight: 600;
            color: #354e8d;
        }

        .seeds-updated {
            background: #e8f5e8 !important;
            border-color: #6b99c2 !important;
            transition: all 0.3s ease;
        }

        .utilization-check {
            margin-top: 8px;
        }

        .utilization-warning {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #f39c12;
            background: rgba(243, 156, 18, 0.1);
            font-size: 0.85rem;
            font-weight: 500;
            text-align: center;
            color: #f39c12;
        }

        .validation-check {
            margin-top: 8px;
        }

        .input-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
        }

        .input-summary h4 {
            margin: 0 0 12px 0;
            color: #354e8d;
            font-size: 1rem;
            font-weight: 600;
        }

        .input-summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }

        .input-group {
            font-size: 0.9rem;
            color: #495057;
        }

        .input-group strong {
            color: #354e8d;
            margin-right: 8px;
        }

        .results-cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .results-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
        }

        .results-card h4 {
            margin: 0 0 12px 0;
            color: #354e8d;
            font-size: 1rem;
            font-weight: 600;
        }

        .validation-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .validation-list li {
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #495057;
        }

        .validation-list li:last-child {
            margin-bottom: 0;
        }

        .validation-list strong {
            color: #354e8d;
            margin-right: 8px;
        }

        /* Input Validation Styles */
        .corrected-value {
            border-color: #d4691e !important;
            background-color: rgba(212, 105, 30, 0.1) !important;
            transition: all 0.3s ease;
        }
        
        .validation-warning {
            color: #d4691e;
            font-size: 0.8rem;
            margin-top: 4px;
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-5px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-5px); }
        }

        @media (max-width: 768px) {
            .results-cards-container {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
    </style>

    <script>
        // Global variable to store recommended seeds
        let recommendedSeeds = 0;

        /**
         * Validates and corrects input values to prevent negative/invalid entries
         * @param {string} inputId - The ID of the input element
         * @param {number} minValue - Minimum allowed value (inclusive)
         * @param {number} maxValue - Maximum allowed value (optional)
         */
        function validateAndUpdate(inputId, minValue, maxValue = null) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            let value = parseFloat(input.value);
            
            // Handle NaN or empty values
            if (isNaN(value) || input.value.trim() === '') {
                value = minValue;
            }
            
            // Apply minimum constraint
            if (value < minValue) {
                value = minValue;
                showValidationWarning(inputId, `Value cannot be less than ${minValue}`);
            }
            
            // Apply maximum constraint if specified
            if (maxValue !== null && value > maxValue) {
                value = maxValue;
                showValidationWarning(inputId, `Value cannot be greater than ${maxValue}`);
            }
            
            // Update input value if it was corrected
            if (parseFloat(input.value) !== value) {
                input.value = value;
                input.classList.add('corrected-value');
                
                // Remove highlight after 2 seconds
                setTimeout(() => {
                    input.classList.remove('corrected-value');
                }, 2000);
            }
        }

        /**
         * Show temporary validation warning
         */
        function showValidationWarning(inputId, message) {
            // Remove existing warnings for this input
            const existingWarning = document.getElementById(`warning-${inputId}`);
            if (existingWarning) {
                existingWarning.remove();
            }
            
            // Create and show new warning
            const input = document.getElementById(inputId);
            const warning = document.createElement('div');
            warning.id = `warning-${inputId}`;
            warning.className = 'validation-warning';
            warning.textContent = message;
            
            input.parentNode.appendChild(warning);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (warning.parentNode) {
                    warning.parentNode.removeChild(warning);
                }
            }, 3000);
        }

        /**
         * Validate all inputs before running simulation
         */
        function validateAllInputs() {
            let isValid = true;
            const validationRules = [
                { id: 'arrivalRateA', min: 0, name: 'Queue A Rate' },
                { id: 'arrivalRateB', min: 0, name: 'Queue B Rate' },
                { id: 'serviceTime', min: 0.1, name: 'Service Time' },
                { id: 'segmentDistance', min: 0.1, name: 'Distance' },
                { id: 'vehicleSpeed', min: 0.1, name: 'Speed' },
                { id: 'minGap', min: 0, name: 'Min Gap' },
                { id: 'customFollowUp', min: 0, max: 60, name: 'Custom Follow-up' },
                { id: 'simulationHours', min: 1, max: 50000, name: 'Simulation Hours' },
                { id: 'numSeeds', min: 1, max: 10000, name: 'Number of Seeds' },
                { id: 'confidenceLevel', min: 85, max: 99.99, name: 'Confidence Level' },
                { id: 'marginError', min: 0.001, name: 'Margin Error' }
            ];
            
            validationRules.forEach(rule => {
                const input = document.getElementById(rule.id);
                if (input && input.style.display !== 'none') {
                    const value = parseFloat(input.value);
                    if (isNaN(value) || value < rule.min || (rule.max && value > rule.max)) {
                        showValidationWarning(rule.id, `${rule.name} must be valid`);
                        isValid = false;
                    }
                }
            });
            
            return isValid;
        }

        // Authentication check on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Give common.js time to load manifest and handle authentication
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Check authentication using common.js functions
            const token = localStorage.getItem('authToken');
            if (!token || !isValidToken(token)) {
                window.location.href = '/login/';
                return;
            }
            
            // Show the app
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
            
            resetInputs();

            // Setup apply sample size button
            document.getElementById('applySampleSize').addEventListener('click', applySampleSize);
        });

        function isValidToken(token) {
            try {
                const decoded = atob(token);
                const [timestamp, username] = decoded.split(':');
                const tokenAge = Date.now() - parseInt(timestamp);
                return tokenAge < 24 * 60 * 60 * 1000; // 24 hours
            } catch {
                return false;
            }
        }

        function updateUtilizationEstimate() {
            try {
                const arrivalRateA = parseFloat(document.getElementById('arrivalRateA').value);
                const arrivalRateB = parseFloat(document.getElementById('arrivalRateB').value);
                const totalArrival = arrivalRateA + arrivalRateB;
                const serviceTime = parseFloat(document.getElementById('serviceTime').value) ;
                const followUpTime = getMinFollowUpValue();
                
                // Update total arrival display
                document.getElementById('totalArrivalDisplay').textContent = totalArrival.toFixed(1);
                
                // Calculate basic utilization (arrival rate * service time / 3600)
                const basicUtilization = (totalArrival * serviceTime) / 3600 * 100;
                
                // Update utilization display
                document.getElementById('utilizationEstimateDisplay').textContent = basicUtilization.toFixed(1) + '%';
                
                // Show warning if follow-up time is less than service time
                const warningDiv = document.getElementById('followUpWarning');
                if (followUpTime < serviceTime) {
                    warningDiv.style.display = 'block';
                } else {
                    warningDiv.style.display = 'none';
                }
                
            } catch (error) {
                console.warn('Could not update utilization estimate:', error);
            }
        }

        // Collect all parameters for runtime estimation and validation
        function collectParameters() {
            return {
                arrivalRateA: parseFloat(document.getElementById('arrivalRateA').value),
                arrivalRateB: parseFloat(document.getElementById('arrivalRateB').value),
                arrivalRate: parseFloat(document.getElementById('arrivalRateA').value) + parseFloat(document.getElementById('arrivalRateB').value),
                serviceTime: parseFloat(document.getElementById('serviceTime').value),
                simulationTime: parseFloat(document.getElementById('simulationHours').value) * 3600,
                simHours: parseFloat(document.getElementById('simulationHours').value),
                minGap: parseFloat(document.getElementById('minGap').value),
                minFollowUp: getMinFollowUpValue(),
                priorityScheme: document.getElementById('priorityScheme').value,
                numSeeds: parseInt(document.getElementById('numSeeds').value),
                seedMode: document.getElementById('seedMode').value
            };
        }

        // Update runtime display when parameters change
        function updateRuntimeDisplay() {
            try {
                const parameters = collectParameters();
                updateRuntimeEstimateDisplay(parameters);
            } catch (error) {
                console.warn('Could not update runtime display:', error);
            }
        }

        function calculateSampleSize() {
            try {
                const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
                const marginError = parseFloat(document.getElementById('marginError').value);
                const simHours = parseFloat(document.getElementById('simulationHours').value);
                const currentSeeds = parseInt(document.getElementById('numSeeds').value);
                
                // Z-scores for common confidence levels
                const zScores = {
                    90: 1.645,
                    95: 1.96,
                    99: 2.576,
                    99.9: 3.291,
                    99.99: 3.891
                };
                
                // Interpolate z-score if not exact match
                let zScore;
                if (zScores[confidenceLevel]) {
                    zScore = zScores[confidenceLevel];
                } else {
                    // Linear interpolation between known values
                    const levels = Object.keys(zScores).map(Number).sort((a, b) => a - b);
                    for (let i = 0; i < levels.length - 1; i++) {
                        if (confidenceLevel >= levels[i] && confidenceLevel <= levels[i + 1]) {
                            const ratio = (confidenceLevel - levels[i]) / (levels[i + 1] - levels[i]);
                            zScore = zScores[levels[i]] + ratio * (zScores[levels[i + 1]] - zScores[levels[i]]);
                            break;
                        }
                    }
                }
                
                if (!zScore) zScore = 1.96; // Default to 95% if can't determine
                
                // Estimate population standard deviation (square root of sum for Poisson processes)
                const totalArrivalRate = parseFloat(document.getElementById('arrivalRateA').value) + 
                                       parseFloat(document.getElementById('arrivalRateB').value);
                const estimatedStdDev = Math.sqrt(totalArrivalRate); // Standard deviation = √(rate) for Poisson
                
                // Sample size calculation: n = (Z * σ / E)²
                const minSampleSize = Math.ceil(Math.pow((zScore * estimatedStdDev) / marginError, 2));
                
                // Adjust for finite population if needed (simulation hours provide finite observations)
                const observationsPerRun = simHours;
                const adjustedSampleSize = Math.ceil(minSampleSize / observationsPerRun);
                
                recommendedSeeds = Math.max(adjustedSampleSize, 10);
                
                const resultDiv = document.getElementById('sampleSizeResult');
                const currentSeedsDisplay = document.getElementById('currentSeedsDisplay');
                const applyButton = document.getElementById('applySampleSize');
                
                // Update current seeds display
                if (currentSeedsDisplay) {
                    currentSeedsDisplay.textContent = currentSeeds;
                }
                
                resultDiv.innerHTML = `
                    <strong>Minimum ${recommendedSeeds} seeds required</strong><br>
                    <small>(${confidenceLevel}% confidence, Z=${zScore.toFixed(3)}, σ=√${totalArrivalRate}=${estimatedStdDev.toFixed(2)})</small>
                `;
                
                // Update button state and styling
                if (applyButton) {
                    if (currentSeeds < recommendedSeeds) {
                        resultDiv.style.borderColor = '#d4691e';
                        resultDiv.style.background = 'rgba(212, 105, 30, 0.1)';
                        resultDiv.innerHTML += '<br><small style="color: #d4691e;">⚠ Currently below recommended seeds.</small>';
                        
                        applyButton.disabled = false;
                        applyButton.textContent = `Use ${recommendedSeeds} Seeds`;
                        applyButton.style.background = '#d4691e';
                    } else if (currentSeeds === recommendedSeeds) {
                        resultDiv.style.borderColor = '#6b99c2';
                        resultDiv.style.background = 'rgba(107, 153, 194, 0.1)';
                        resultDiv.innerHTML += '<br><small style="color: #6b99c2;">✓ Current seeds exactly at minimum</small>';
                        
                        applyButton.disabled = true;
                        applyButton.textContent = 'Already at Minimum';
                        applyButton.style.background = '#95a5a6';
                    } else {
                        resultDiv.style.borderColor = '#6b99c2';
                        resultDiv.style.background = 'rgba(107, 153, 194, 0.1)';
                        resultDiv.innerHTML += '<br><small style="color: #6b99c2;">✓ Current seeds adequate</small>';
                        
                        applyButton.disabled = false;
                        applyButton.textContent = `Use ${recommendedSeeds} Seeds`;
                        applyButton.style.background = '#6b99c2';
                    }
                }
                
            } catch (error) {
                const resultDiv = document.getElementById('sampleSizeResult');
                resultDiv.innerHTML = `<span style="color: #d4691e;">⚠️ ${error.message}</span>`;
                resultDiv.style.borderColor = '#d4691e';
                resultDiv.style.background = 'rgba(212, 105, 30, 0.1)';
            }
        }

        function applySampleSize() {
            if (recommendedSeeds > 0) {
                const numSeedsInput = document.getElementById('numSeeds');
                const oldValue = numSeedsInput.value;
                numSeedsInput.value = recommendedSeeds;
                
                // Add visual feedback class
                numSeedsInput.classList.add('seeds-updated');
                
                // Trigger change events to update other dependent calculations
                updateRuntimeDisplay();
                calculateSampleSize();
                
                // Remove visual feedback after 2 seconds
                setTimeout(() => {
                    numSeedsInput.classList.remove('seeds-updated');
                }, 2000);
                
                console.log(`Applied sample size: ${oldValue} → ${recommendedSeeds} seeds`);
            }
        }

        function toggleServiceMode() {
            const mode = document.getElementById('serviceMode').value;
            const fixedGroup = document.getElementById('fixedServiceGroup');
            const speedGroup = document.getElementById('speedServiceGroup');
            
            if (mode === 'fixed') {
                fixedGroup.style.display = 'block';
                speedGroup.style.display = 'none';
            } else {
                fixedGroup.style.display = 'none';
                speedGroup.style.display = 'block';
                calculateServiceTime();
            }
        }

        function calculateServiceTime() {
            const distance = parseFloat(document.getElementById('segmentDistance').value);
            const speed = parseFloat(document.getElementById('vehicleSpeed').value);
            
            if (distance && speed) {
                const serviceTime = distance / (speed * 1000 / 3600); // Convert km/h to m/s
                document.getElementById('serviceTime').value = serviceTime.toFixed(2);
                updateUtilizationEstimate();
            }
        }

        function generateValidationCheck(results, params) {
            const expectedArrivalA = params.arrivalRateA;
            const expectedArrivalB = params.arrivalRateB;
            
            const actualArrivalA = results.arrivalRates[0] ? results.arrivalRates[0].totalPerHour : 0;
            const actualArrivalB = results.arrivalRates[1] ? results.arrivalRates[1].totalPerHour : 0;
            
            const marginError = parseFloat(document.getElementById('marginError').value) ;
            const errorA = Math.abs(expectedArrivalA - actualArrivalA);
            const errorB = Math.abs(expectedArrivalB - actualArrivalB);
            const totalError = errorA + errorB;
            
            const validationPassed = Math.max(errorA, errorB) <= marginError;
            
            return `
                <h4>${validationPassed === null ? '⚠️' : validationPassed ? '✅' : '⚠️'} Arrival Rate Validation</h4>
                <ul class="validation-list">
                    <li><strong>Expected:</strong> A=${expectedArrivalA.toFixed(2)}, B=${expectedArrivalB.toFixed(2)}</li>
                    <li><strong>Actual:</strong> A=${actualArrivalA.toFixed(2)}, B=${actualArrivalB.toFixed(2)}</li>
                    <li><strong>Error:</strong> ${totalError.toFixed(3)} (A=${errorA.toFixed(3)} + B=${errorB.toFixed(3)})</li>
                    <li><strong>Status:</strong> ${validationPassed ? 'Rates validated successfully' : 'Rates outside margin'} (±${marginError})</li>
                </ul>
            `;
        }

        function resetInputs() {
            // Clear validation warnings
            document.querySelectorAll('.validation-warning').forEach(warning => {
                warning.remove();
            });
            document.querySelectorAll('.corrected-value').forEach(input => {
                input.classList.remove('corrected-value');
            });
            
            document.getElementById('arrivalRateA').value = '15';
            document.getElementById('arrivalRateB').value = '15';
            document.getElementById('serviceMode').value = 'fixed';
            document.getElementById('serviceTime').value = '5.4';
            document.getElementById('segmentDistance').value = '30';
            document.getElementById('vehicleSpeed').value = '20';
            document.getElementById('simulationHours').value = '1000';
            document.getElementById('minGap').value = '0';
            document.getElementById('minFollowUp').value = 'serviceTime';
            document.getElementById('priorityScheme').value = 'FCFS';
            document.getElementById('confidenceLevel').value = '99.9';
            document.getElementById('marginError').value = '0.05';
            document.getElementById('numSeeds').value = '130';
            document.getElementById('seedMode').value = 'fixed';
            document.getElementById('customFollowUp').value = '2';
            
            toggleServiceMode();
            toggleCustomFollowUp();
            updateUtilizationEstimate();
            calculateSampleSize();
            updateRuntimeDisplay();
        }

        function displayResults(results, params) {
            const container = document.getElementById('resultsContent');
            
            let html = `
                <div class="results-cards-container">
                    <div class="input-summary">
                        <h4>Input Parameters</h4>
                        <div class="input-summary-grid">
                            <div class="input-group">
                                <strong>Model:</strong> Two-Way Passing/ Single Lane Road
                            </div>
                            <div class="input-group">
                                <strong>Queue A Rate:</strong> ${params.arrivalRateA} cars/hr
                            </div>
                            <div class="input-group">
                                <strong>Queue B Rate:</strong> ${params.arrivalRateB} cars/hr
                            </div>
                            <div class="input-group">
                                <strong>Total Arrivals:</strong> ${(params.arrivalRateA + params.arrivalRateB).toFixed(1)} cars/hr
                            </div>
                            <div class="input-group">
                                <strong>Service Time:</strong> ${params.serviceTime}s
                            </div>
                            <div class="input-group">
                                <strong>Min Gap:</strong> ${params.minGap}s
                            </div>
                            <div class="input-group">
                                <strong>Min Follow-up:</strong> ${params.minFollowUp}s
                            </div>
                            <div class="input-group">
                                <strong>Priority:</strong> ${document.getElementById('priorityScheme').options[document.getElementById('priorityScheme').selectedIndex].text}
                            </div>
                            <div class="input-group">
                                <strong>Simulation:</strong> ${params.simHours}h × ${params.numSeeds} seeds
                            </div>
                        </div>
                    </div>
                    
                    <div class="results-card">
                        ${generateValidationCheck(results, params)}
                    </div>
                </div>
                
                <div class="metrics-section">
                    <h4 style="color: #354e8d; margin-bottom: 8px; font-size: 1rem; font-weight: 600; text-align: center;">Utilization Analysis</h4>
                    <table class="metrics-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Utilization %</th>
                                <th>Delay Probability</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align: left; font-weight: 600;">Road Segment (Total)</td>
                                <td style="color: #354e8d; font-weight: 600;">${results.serverUtilization.toFixed(2)}%</td>
                                <td>—</td>
                            </tr>
                            <tr>
                                <td style="text-align: left; font-weight: 600;">Queue A Direction</td>
                                <td>${results.directionalUtilization[0].toFixed(2)}%</td>
                                <td>${((results.delays[0].queuedVehicles / (params.simulationTime / 3600)) / results.arrivalRates[0].totalPerHour * 100).toFixed(1)}%</td>
                            </tr>
                            <tr>
                                <td style="text-align: left; font-weight: 600;">Queue B Direction</td>
                                <td>${results.directionalUtilization[1].toFixed(2)}%</td>
                                <td>${((results.delays[1].queuedVehicles / (params.simulationTime / 3600)) / results.arrivalRates[1].totalPerHour * 100).toFixed(1)}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="tables-container">
                    <div class="table-section">
                        <h4>Queue A Analysis</h4>
                        <div class="table-content">
                            <div class="distribution-table-container">
                                <table class="distribution-table">
                                    <thead>
                                        <tr>
                                            <th>Queue Length</th>
                                            <th>% Time</th>
                                            <th>% Time Cumulative</th>
                                            <th>% Hours Max</th>
                                            <th>% Hours Max Cumulative</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            // Build Queue A table with cumulative calculations
            const queueA = results.queues[0];
            const allLengthsA = new Set([
                ...Object.keys(queueA.lengthPercentages),
                ...Object.keys(queueA.maxPercentages)
            ]);
            
            const sortedLengthsA = Array.from(allLengthsA)
                .map(l => parseInt(l))
                .sort((a, b) => a - b)
                .slice(0, 10);
            
            let timeCumulative = 0;
            let maxCumulative = 0;
            
            for (const length of sortedLengthsA) {
                const timePercent = queueA.lengthPercentages[length];
                const maxPercent = queueA.maxPercentages[length];
                
                timeCumulative += timePercent;
                maxCumulative += maxPercent;
                
                if (timePercent > 0.01 || maxPercent > 0.01) {
                    html += `
                        <tr>
                            <td>${length}</td>
                            <td>${timePercent.toFixed(2)}%</td>
                            <td><strong>${timeCumulative.toFixed(2)}%</strong></td>
                            <td>${maxPercent.toFixed(2)}%</td>
                            <td><strong>${maxCumulative.toFixed(2)}%</strong></td>
                        </tr>
                    `;
                }
            }
            
            html += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="wait-stats">
                                <h5>Wait Time Statistics</h5>
                                <ul class="wait-stat-list">
                                    <li>
                                        <span>Avg. delay per vehicle:</span>
                                        <span>${results.delays[0].avgDelayAll.toFixed(2)} s</span>
                                    </li>
                                    <li>
                                        <span>Avg. delay per queued:</span>
                                        <span>${results.delays[0].avgDelayQueued.toFixed(2)} s</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-section">
                        <h4>Queue B Analysis</h4>
                        <div class="table-content">
                            <div class="distribution-table-container">
                                <table class="distribution-table">
                                    <thead>
                                        <tr>
                                            <th>Queue Length</th>
                                            <th>% Time</th>
                                            <th>% Time Cumulative</th>
                                            <th>% Hours Max</th>
                                            <th>% Hours Max Cumulative</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            // Build Queue B table with cumulative calculations
            const queueB = results.queues[1];
            const allLengthsB = new Set([
                ...Object.keys(queueB.lengthPercentages),
                ...Object.keys(queueB.maxPercentages)
            ]);
            
            const sortedLengthsB = Array.from(allLengthsB)
                .map(l => parseInt(l))
                .sort((a, b) => a - b)
                .slice(0, 10);
            
            timeCumulative = 0;
            maxCumulative = 0;
            
            for (const length of sortedLengthsB) {
                const timePercent = queueB.lengthPercentages[length];
                const maxPercent = queueB.maxPercentages[length];
                
                timeCumulative += timePercent;
                maxCumulative += maxPercent;
                
                if (timePercent > 0.01 || maxPercent > 0.01) {
                    html += `
                        <tr>
                            <td>${length}</td>
                            <td>${timePercent.toFixed(2)}%</td>
                            <td><strong>${timeCumulative.toFixed(2)}%</strong></td>
                            <td>${maxPercent.toFixed(2)}%</td>
                            <td><strong>${maxCumulative.toFixed(2)}%</strong></td>
                        </tr>
                    `;
                }
            }
            
            html += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="wait-stats">
                                <h5>Wait Time Statistics</h5>
                                <ul class="wait-stat-list">
                                    <li>
                                        <span>Avg. delay per vehicle:</span>
                                        <span>${results.delays[1].avgDelayAll.toFixed(2)} s</span>
                                    </li>
                                    <li>
                                        <span>Avg. delay per queued:</span>
                                        <span>${results.delays[1].avgDelayQueued.toFixed(2)} s</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tables-container">
            `;
            
            // Add arrival breakdown for each direction
            for (let i = 0; i < results.arrivalRates.length; i++) {
                const arrivalRate = results.arrivalRates[i];
                const queueName = i === 0 ? 'Queue A' : 'Queue B';
                
                // Calculate immediate entry (vehicles that didn't queue)
                const immediateEntry = arrivalRate.totalPerHour - arrivalRate.sameQueue - arrivalRate.oppositeQueue - arrivalRate.noqueue;
                const samePercentage = arrivalRate.totalPerHour > 0 ? (arrivalRate.sameQueue / arrivalRate.totalPerHour) * 100 : 0;
                const oppositePercentage = arrivalRate.totalPerHour > 0 ? (arrivalRate.oppositeQueue / arrivalRate.totalPerHour) * 100 : 0;
                const noqueuePercentage = arrivalRate.totalPerHour > 0 ? (arrivalRate.noqueue / arrivalRate.totalPerHour) * 100 : 0;
                const immediatePercentage = arrivalRate.totalPerHour > 0 ? (immediateEntry / arrivalRate.totalPerHour) * 100 : 0;
                
                html += `
                    <div class="table-section">
                        <h4>${queueName} - Arrival Breakdown</h4>
                        <div class="table-content">
                            <div class="wait-stats">
                                <h5>Queuing Reasons</h5>
                                <ul class="wait-stat-list">
                                    <li>
                                        <span>Queued - Same Direction Busy:</span>
                                        <span>(${samePercentage.toFixed(1)}%) ${arrivalRate.sameQueue.toFixed(2)} cars/hr</span>
                                    </li>
                                    <li>
                                        <span>Queued - Opposite Direction Busy:</span>
                                        <span>(${oppositePercentage.toFixed(1)}%) ${arrivalRate.oppositeQueue.toFixed(2)} cars/hr</span>
                                    </li>
                                    <li>
                                        <span>Queued - Road Empty (Follow-up Constraint):</span>
                                        <span>(${noqueuePercentage.toFixed(1)}%) ${arrivalRate.noqueue.toFixed(2)} cars/hr</span>
                                    </li>
                                    <li>
                                        <span>Immediate Entry (No Queue):</span>
                                        <span>(${immediatePercentage.toFixed(1)}%) ${immediateEntry.toFixed(2)} cars/hr</span>
                                    </li>
                                </ul>
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e9ecef;">
                                    <strong>Total Arrivals: (100.0%) ${arrivalRate.totalPerHour.toFixed(2)} cars/hr</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += `
                </div>
            `;

            container.innerHTML = html;
        }

        function getMinFollowUpValue() {
            const selection = document.getElementById('minFollowUp').value;
            const serviceTime = parseFloat(document.getElementById('serviceTime').value);
            const minGap = parseFloat(document.getElementById('minGap').value);
            
            switch(selection) {
                case '0': return 0;
                case 'minGap': return minGap;
                case 'serviceTime': return serviceTime;
                case 'custom': return parseFloat(document.getElementById('customFollowUp').value);
                default: return serviceTime;
            }
        }

        function toggleCustomFollowUp() {
            const selection = document.getElementById('minFollowUp').value;
            const customGroup = document.getElementById('customFollowUpGroup');
            customGroup.style.display = selection === 'custom' ? 'block' : 'none';
        }

        // Event listeners
        document.getElementById('resetButton').addEventListener('click', resetInputs);

        document.getElementById('runSimulation').addEventListener('click', async () => {
            const token = localStorage.getItem('authToken');
            if (!token || !isValidToken(token)) {
                window.location.href = '/login/';
                return;
            }

            const runButton = document.getElementById('runSimulation');
            if (runButton.disabled) return;

            // Validate all inputs before proceeding
            if (!validateAllInputs()) {
                const status = document.getElementById('status');
                status.style.display = 'block';
                status.className = 'status error';
                status.textContent = 'Please correct the input validation errors before running simulation.';
                return;
            }

            const parameters = collectParameters();
            const estimatedMs = estimateSimulationRuntime(parameters);
            const estimatedTimeStr = formatEstimatedTime(estimatedMs);
            const numSeeds = parameters.numSeeds;

            // UI Elements
            const elements = {
                status: document.getElementById('status'),
                progressContainer: document.getElementById('progressContainer'),
                progressFill: document.getElementById('progressFill'),
                progressPercentage: document.getElementById('progressPercentage'),
                progressDetails: document.getElementById('progressDetails'),
                resultsContent: document.getElementById('resultsContent')
            };

            // Show loading state
            runButton.disabled = true;
            runButton.textContent = `Running simulation...`;
            elements.status.style.display = 'block';
            elements.status.className = 'status running';
            elements.status.textContent = `Running simulation...`;
            elements.progressContainer.style.display = 'block';
            elements.resultsContent.innerHTML = `<div class="no-results"><h4>Running simulation...</h4></div>`;

            // Scroll to progress bar using common.js function
            scrollToProgress();

            // Start progress tracking from common.js
            const progressInterval = createRealisticProgress(estimatedMs, elements.progressFill, elements.progressPercentage, elements.progressDetails);
            const startTime = Date.now();

            try {
                const response = await fetch('/api/two-way-passing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'runSimulation',
                        parameters: parameters
                    })
                });

                clearInterval(progressInterval);

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login/';
                    return;
                }

                if (!response.headers.get('content-type')?.includes('application/json')) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Simulation failed');

                // Complete progress and show results
                const actualTime = Date.now() - startTime;
                
                elements.progressFill.style.width = '100%';
                elements.progressPercentage.textContent = '100%';
                elements.progressDetails.textContent = 'Complete!';
                elements.status.className = 'status complete';
                elements.status.textContent = `Completed!`;
                
                displayResults(data.results, parameters);

                // Scroll to results using common.js function after a brief delay to allow for DOM updates
                setTimeout(() => {
                    scrollToResults();
                }, 300);

                setTimeout(() => {
                    elements.status.style.display = 'none';
                    elements.progressContainer.style.display = 'none';
                }, 4000);

            } catch (error) {
                clearInterval(progressInterval);
                elements.status.className = 'status error';
                elements.status.textContent = 'Error: ' + error.message;
                elements.resultsContent.innerHTML = `<div class="no-results"><h4>Error</h4><p>${error.message}</p></div>`;
                
                // Still scroll to results section even on error so user can see the error message
                setTimeout(() => {
                    scrollToResults();
                }, 300);
            }

            runButton.disabled = false;
            runButton.textContent = 'Run Simulation';
        });
    </script>
</body>
</html>