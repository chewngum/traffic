<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Labb - Car Lift</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="module" src="/common.js"></script><script src="/utils/api-config.js"></script>
    <style>
        .sample-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: center;
        }

        .current-seeds-info {
            font-size: 0.75rem;
            color: #666;
            text-align: right;
            flex: 1;
        }

        #currentSeedsDisplay {
            font-weight: 600;
            color: #354e8d;
        }

        .seeds-updated {
            background: #e8f5e8 !important;
            border-color: #6b99c2 !important;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <h2>Verifying access...</h2>
    </div>

    <div id="app" class="container hidden">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="header-title">
                    <h1>Car Lift Simulation</h1>
                </div>
            </div>
        </div>
            
        <div class="main-content">
            <div class="glass-card">
                <h3 class="section-title">Configuration</h3>
                
                <div class="cards-container">
                    <div class="card">
                        <div class="card-title">Building Configuration</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="numFloors">Number of Floors:</label>
                                <input type="number" id="numFloors" min="2" max="10" value="2" onchange="generateRateInputs(); validateCapacity(); updateRuntimeDisplay()">
                            </div>
                            <div class="form-group">
                                <label for="lobbyFloor">Lobby Floor:</label>
                                <input type="number" id="lobbyFloor" min="1" value="1" onchange="generateRateInputs(); validateCapacity(); updateRuntimeDisplay()">
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid #e3f1f7; margin: 15px 0; padding-top: 15px;">
                            <h4 style="color: #354e8d; margin-bottom: 12px; font-size: 1rem; font-weight: 600; text-align: center; padding: 8px; background: linear-gradient(135deg, #f8fbff 0%, #e3f1f7 100%); border-radius: 6px; border: 1px solid #d1e7f0;">Per Floor Traffic Rates (cars per hour)</h4>
                            <div class="rates-container" id="ratesContainer">
                                <!-- Rates will be generated dynamically -->
                            </div>
                        </div>
                        <div class="validation-check">
                            <strong>Total Traffic Rate:</strong> <span id="totalTrafficDisplay">60.0</span> cars/hour
                        </div>
                        <div class="validation-check" style="margin-top: 8px;">
                            <strong>Utilisation Range:</strong> <span id="utilizationDisplay">N/A</span>
                        </div>
                        <div id="utilizationWarning" class="capacity-warning" style="display: none;">
                            <span id="utilizationMessage"></span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Lift Parameters (seconds)</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="doorOpenTime">Door Opening:</label>
                                <input type="number" id="doorOpenTime" step="0.1" value="5" min="0" onchange="validateCapacity(); updateRuntimeDisplay()">
                            </div>
                            <div class="form-group">
                                <label for="doorCloseTime">Door Closing:</label>
                                <input type="number" id="doorCloseTime" step="0.1" value="5" min="0" onchange="validateCapacity(); updateRuntimeDisplay()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="enterTime">Entering Lift:</label>
                                <input type="number" id="enterTime" step="0.1" value="15" min="0" onchange="validateCapacity(); updateRuntimeDisplay()">
                            </div>
                            <div class="form-group">
                                <label for="exitTime">Exiting Lift:</label>
                                <input type="number" id="exitTime" step="0.1" value="15" min="0" onchange="validateCapacity(); updateRuntimeDisplay()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="verticalSpeed">Floor to Floor:</label>
                                <input type="number" id="verticalSpeed" step="0.1" value="20" min="0.000001" onchange="validateCapacity(); updateRuntimeDisplay()">
                            </div>
                            <div class="form-group">
                                <label for="bufferTime">Leveling Buffer:</label>
                                <input type="number" id="bufferTime" step="0.1" value="2" min="0" onchange="validateCapacity(); updateRuntimeDisplay()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="minHeadway">Min Arrival Headway:</label>
                            <input type="number" id="minHeadway" step="0.1" min="0" value="3.0">
                            <div class="help-text">Minimum time between consecutive arrivals</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Simulation Settings</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="simHours">Simulation Hours:</label>
                                <input type="number" id="simHours" step="1" min="1" max="2000" value="1000" onchange="calculateSampleSize(); updateRuntimeDisplay()">
                            </div>
                            <div class="form-group">
                                <label for="numSeeds">Number of Seeds:</label>
                                <input type="number" id="numSeeds" min="1" max="10000" value="15" onchange="calculateSampleSize(); updateRuntimeDisplay()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="seedMode">Seed Mode:</label>
                                <select id="seedMode">
                                    <option value="fixed" selected>Fixed (Reproducible)</option>
                                    <option value="random">Random</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Estimated Runtime:</label>
                                <div id="runtimeEstimate" class="help-text" style="font-weight: 600;">Calculating...</div>
                            </div>
                        </div>
                        
                        <div class="sample-calculator">
                            <h4 style="color: #354e8d; margin-bottom: 8px; font-size: 0.95rem; font-weight: 600;">Sample Size Calculator</h4>
                            <p style="margin-bottom: 8px; font-size: 0.8rem; color: #666;">Calculate minimum seeds for statistical confidence</p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="confidenceLevel">Confidence Level:</label>
                                    <select id="confidenceLevel" onchange="calculateSampleSize()">
                                        <option value="90">90%</option>
                                        <option value="95">95%</option>
                                        <option value="99">99%</option>
                                        <option value="99.9" selected>99.9%</option>
                                        <option value="99.99">99.99%</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="marginOfError">Margin of Error (% of trips):</label>
                                    <input type="number" id="marginOfError" value="0.5" min="0.0001" step="0.11" onchange="calculateSampleSize()">
                                </div>
                            </div>
                            
                            <div id="sampleSizeResult" class="sample-result">
                                Calculating minimum seeds...
                            </div>
                            
                            <div class="sample-actions">
                                <button id="applySampleSize" class="apply-sample-btn">
                                    Use Minimum Seeds
                                </button>
                                <div class="current-seeds-info">
                                    Current: <span id="currentSeedsDisplay">10</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="buttons-row">
                    <button class="btn btn-reset" onclick="resetForm()">Reset</button>
                    <button class="btn btn-run" onclick="runSimulation()" id="runButton">Run Simulation</button>
                </div>
                
                <div class="status" id="status" style="display: none;"></div>
                <div class="progress-bar" id="progressContainer" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text">
                        <div id="progressPercentage">0%</div>
                        <div id="progressDetails">Initializing...</div>
                    </div>
                </div>
            </div>
            
            <div class="results-container" id="resultsSection">
                <h3 class="section-title">Results</h3>
                
                <div id="resultsContent">
                    <div class="no-results">
                        <h4>Results will appear here</h4>
                        <p>Configure parameters and run simulation to see results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let recommendedSeeds = 0;
        let theoreticalMinUtilization = 0;
        let theoreticalMaxUtilization = 0;

        // Authentication check on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Give common.js time to load manifest and handle authentication
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Check authentication using common.js functions
            const token = localStorage.getItem('authToken');
            if (!token || !isValidToken(token)) {
                window.location.href = '/login/';
                return;
            }
            
            // Show the app
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
            
            // Initialize
            resetForm();
            
            // Setup apply sample size button
            document.getElementById('applySampleSize').addEventListener('click', applySampleSize);
        });

        function isValidToken(token) {
            try {
                const decoded = atob(token);
                const [timestamp, username] = decoded.split(':');
                const tokenAge = Date.now() - parseInt(timestamp);
                return tokenAge < 24 * 60 * 60 * 1000; // 24 hours
            } catch {
                return false;
            }
        }

        function validateAndParseFloat(elementId, min = 0, max = Infinity, defaultValue = null) {
            const element = document.getElementById(elementId);
            const value = parseFloat(element.value);
            
            if (isNaN(value)) {
                if (defaultValue !== null) {
                    element.value = defaultValue;
                    element.style.borderColor = '';
                    return defaultValue;
                } else {
                    element.style.borderColor = '#d4691e';
                    throw new Error(`Invalid value for ${elementId}: must be a number`);
                }
            }
            
            if (value < min || value > max) {
                element.style.borderColor = '#d4691e';
                throw new Error(`${elementId} must be between ${min} and ${max}`);
            }
            
            element.style.borderColor = ''; // Reset border
            return value;
        }

        function validateAndParseInt(elementId, min = 1, max = Infinity, defaultValue = null) {
            const element = document.getElementById(elementId);
            const value = parseInt(element.value);
            
            if (isNaN(value)) {
                if (defaultValue !== null) {
                    element.value = defaultValue;
                    element.style.borderColor = '';
                    return defaultValue;
                } else {
                    element.style.borderColor = '#d4691e';
                    throw new Error(`Invalid value for ${elementId}: must be a whole number`);
                }
            }
            
            if (value < min || value > max) {
                element.style.borderColor = '#d4691e';
                throw new Error(`${elementId} must be between ${min} and ${max}`);
            }
            
            element.style.borderColor = ''; // Reset border
            return value;
        }

        // Update runtime display when parameters change
        function updateRuntimeDisplay() {
            try {
                const parameters = collectParameters();
                updateRuntimeEstimateDisplay(parameters);
            } catch (error) {
                console.warn('Could not update runtime display:', error);
            }
        }

        // Format large numbers in scientific notation with superscript
        function formatScientific(num) {
            if (num === 0) return '0';
            if (num < 1000) return num.toString();
            
            const exp = Math.floor(Math.log10(Math.abs(num)));
            const mantissa = (num / Math.pow(10, exp)).toFixed(1);
            return `${mantissa} × 10<sup>${exp}</sup>`;
        }

        // Generate rate inputs based on number of floors
        function generateRateInputs() {
            const numFloors = parseInt(document.getElementById('numFloors').value) || 2;
            const container = document.getElementById('ratesContainer');
            
            // Store current lobby floor before potential update
            const currentLobbyFloor = parseInt(document.getElementById('lobbyFloor').value) || 1;
            
            // Store existing rate values to preserve user input when possible
            const existingRates = {};
            for (let f = 1; f <= 10; f++) {
                const arrivalInput = document.getElementById(`arrivalRate${f}`);
                const departureInput = document.getElementById(`departureRate${f}`);
                if (arrivalInput) existingRates[`arrival_${f}`] = parseFloat(arrivalInput.value);
                if (departureInput) existingRates[`departure_${f}`] = parseFloat(departureInput.value);
            }
            
            // Update lobby floor max and adjust if necessary
            document.getElementById('lobbyFloor').max = numFloors;
            const lobbyFloorChanged = currentLobbyFloor > numFloors;
            if (lobbyFloorChanged) {
                document.getElementById('lobbyFloor').value = numFloors;
                // If lobby floor changed due to floor reduction, clear its old rate values
                delete existingRates[`arrival_${currentLobbyFloor}`];
                delete existingRates[`departure_${currentLobbyFloor}`];
            }
            
            // Get the potentially updated lobby floor
            const lobbyFloor = parseInt(document.getElementById('lobbyFloor').value) || 1;
            
            container.innerHTML = '';
            
            for (let f = 1; f <= numFloors; f++) {
                const rateRow = document.createElement('div');
                
                if (f === lobbyFloor) {
                    rateRow.className = 'rate-row lobby-row';
                    rateRow.innerHTML = `
                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                            <span style="display: inline-block; width: 8px; height: 8px; background: #6b99c2; border-radius: 50%; margin-right: 6px;"></span>
                            <label style="font-weight: 600; color: #354e8d; font-size: 0.8rem;">Floor ${f} (Lobby)</label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; text-align: center;">
                            <div style="padding: 4px; background: rgba(255,255,255,0.7); border-radius: 3px; color: #354e8d; font-size: 0.75em; font-weight: 500;">
                                <div style="font-size: 0.65em; margin-bottom: 1px; opacity: 0.8;">Arrivals</div>
                                <div>N/A</div>
                            </div>
                            <div style="padding: 4px; background: rgba(255,255,255,0.7); border-radius: 3px; color: #354e8d; font-size: 0.75em; font-weight: 500;">
                                <div style="font-size: 0.65em; margin-bottom: 1px; opacity: 0.8;">Departures</div>
                                <div>N/A</div>
                            </div>
                        </div>
                    `;
                } else {
                    rateRow.className = 'rate-row traffic-row';
                    
                    // Set default values to 15 if no existing values
                    const defaultArrival = existingRates[`arrival_${f}`] !== undefined ? existingRates[`arrival_${f}`] : 15;
                    const defaultDeparture = existingRates[`departure_${f}`] !== undefined ? existingRates[`departure_${f}`] : 15;
                    
                    rateRow.innerHTML = `
                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                            <span style="display: inline-block; width: 6px; height: 6px; background: #a3c9e0; border-radius: 50%; margin-right: 6px;"></span>
                            <label style="font-weight: 600; color: #354e8d; font-size: 0.8rem;">Floor ${f}</label>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                            <div style="background: rgba(255,255,255,0.9); padding: 4px; border-radius: 3px; border: 1px solid #e1ecf0;">
                                <label style="display: block; font-size: 0.65em; color: #5a7ba3; margin-bottom: 1px; font-weight: 500;">L→${f} Arrivals:</label>
                                <input type="number" id="arrivalRate${f}" step="0.1" value="${defaultArrival}" min="0" onchange="updateTotalTraffic(); validateCapacity(); updateRuntimeDisplay()" 
                                       style="width: 100%; padding: 2px 3px; border: 1px solid #c5dae5; border-radius: 2px; font-size: 0.75rem; text-align: center; background: #fff;">
                            </div>
                            <div style="background: rgba(255,255,255,0.9); padding: 4px; border-radius: 3px; border: 1px solid #e1ecf0;">
                                <label style="display: block; font-size: 0.65em; color: #5a7ba3; margin-bottom: 1px; font-weight: 500;">${f}→L Departures:</label>
                                <input type="number" id="departureRate${f}" step="0.1" value="${defaultDeparture}" min="0" onchange="updateTotalTraffic(); validateCapacity(); updateRuntimeDisplay()" 
                                       style="width: 100%; padding: 2px 3px; border: 1px solid #c5dae5; border-radius: 2px; font-size: 0.75rem; text-align: center; background: #fff;">
                            </div>
                        </div>
                    `;
                }
                
                // Add hover effect for non-lobby rows
                if (f !== lobbyFloor) {
                    rateRow.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateY(-1px)';
                        this.style.boxShadow = '0 2px 6px rgba(52, 78, 141, 0.12)';
                        this.style.borderColor = '#b8dae6';
                    });
                    
                    rateRow.addEventListener('mouseleave', function() {
                        this.style.transform = 'translateY(0)';
                        this.style.boxShadow = '0 1px 2px rgba(52, 78, 141, 0.06)';
                        this.style.borderColor = '#d1e7f0';
                    });
                }
                
                container.appendChild(rateRow);
            }
            
            setTimeout(() => {
                updateTotalTraffic();
                validateCapacity();
                calculateSampleSize();
                updateRuntimeDisplay();
            }, 100);
        }

        function updateTotalTraffic() {
            try {
                const numFloors = parseInt(document.getElementById('numFloors').value);
                const lobbyFloor = parseInt(document.getElementById('lobbyFloor').value);
                
                let totalTrafficRate = 0;
                for (let f = 1; f <= numFloors; f++) {
                    if (f === lobbyFloor) continue;
                    const arrivalInput = document.getElementById(`arrivalRate${f}`);
                    const departureInput = document.getElementById(`departureRate${f}`);
                    if (arrivalInput) totalTrafficRate += parseFloat(arrivalInput.value) || 0;
                    if (departureInput) totalTrafficRate += parseFloat(departureInput.value) || 0;
                }
                
                document.getElementById('totalTrafficDisplay').textContent = totalTrafficRate.toFixed(1);
            } catch (error) {
                document.getElementById('totalTrafficDisplay').textContent = '0.0';
            }
        }

        function getZScoreForConfidence(confidenceLevel) {
            const zScores = {
                90: 1.645,
                95: 1.960,
                99: 2.576,
                99.9: 3.291,
                99.99: 3.891
            };
            return zScores[confidenceLevel];
        }

        function calculateSampleSize() {
            try {
                const confidenceLevel = validateAndParseFloat('confidenceLevel');

                const simHours = validateAndParseFloat('simHours', 1);
                const numFloors = validateAndParseInt('numFloors', 2, 10);
                const lobbyFloor = validateAndParseInt('lobbyFloor', 1, numFloors);
                const currentSeeds = parseInt(document.getElementById('numSeeds').value) || 15;
                
                
                // Calculate total traffic rate
                let totalTrafficRate = 0;
                for (let f = 1; f <= numFloors; f++) {
                    if (f === lobbyFloor) continue;
                    const arrivalInput = document.getElementById(`arrivalRate${f}`);
                    const departureInput = document.getElementById(`departureRate${f}`);
                    if (arrivalInput) totalTrafficRate += parseFloat(arrivalInput.value) || 0;
                    if (departureInput) totalTrafficRate += parseFloat(departureInput.value) || 0;
                }
                
                // Handle zero traffic case
                if (totalTrafficRate === 0) {
                    const resultDiv = document.getElementById('sampleSizeResult');
                    const currentSeedsDisplay = document.getElementById('currentSeedsDisplay');
                    const applyButton = document.getElementById('applySampleSize');
                    
                    if (currentSeedsDisplay) {
                        currentSeedsDisplay.textContent = currentSeeds;
                    }
                    
                    resultDiv.innerHTML = `
                        <strong>Sample size calculation not applicable</strong><br>
                        <small style="color: #999;">Zero traffic rate - no statistical analysis needed</small>
                    `;
                    resultDiv.style.borderColor = '#999';
                    resultDiv.style.background = 'rgba(153, 153, 153, 0.1)';
                    
                    if (applyButton) {
                        applyButton.disabled = true;
                        applyButton.textContent = 'N/A for Zero Rate';
                        applyButton.style.background = '#95a5a6';
                    }
                    return;
                }
                const marginOfError = validateAndParseFloat('marginOfError', 0.001) * totalTrafficRate / 100;

                const zScore = getZScoreForConfidence(confidenceLevel);
                const estimatedStdDev = Math.sqrt(totalTrafficRate);
                const minSampleSize = Math.ceil(Math.pow((zScore * estimatedStdDev) / marginOfError, 2));
                const adjustedSampleSize = Math.ceil(minSampleSize / simHours);
                recommendedSeeds = Math.max(adjustedSampleSize, 1);
                
                const resultDiv = document.getElementById('sampleSizeResult');
                const currentSeedsDisplay = document.getElementById('currentSeedsDisplay');
                const applyButton = document.getElementById('applySampleSize');
                
                // Update current seeds display
                if (currentSeedsDisplay) {
                    currentSeedsDisplay.textContent = currentSeeds;
                }
                
                resultDiv.innerHTML = `
                    <strong>Minimum ${recommendedSeeds} seeds required</strong><br>
                    <small>(${confidenceLevel}% confidence, Z=${zScore.toFixed(3)}, σ=√${totalTrafficRate}=${estimatedStdDev.toFixed(2)})</small>
                `;
                
                // Update button state and styling
                if (applyButton) {
                    if (currentSeeds < recommendedSeeds) {
                        resultDiv.style.borderColor = '#d4691e';
                        resultDiv.style.background = 'rgba(212, 105, 30, 0.1)';
                        resultDiv.innerHTML += '<br><small style="color: #d4691e;">⚠ Currently below recommended seeds.</small>';
                        
                        applyButton.disabled = false;
                        applyButton.textContent = `Use ${recommendedSeeds} Seeds`;
                        applyButton.style.background = '#d4691e';
                    } else if (currentSeeds === recommendedSeeds) {
                        resultDiv.style.borderColor = '#6b99c2';
                        resultDiv.style.background = 'rgba(107, 153, 194, 0.1)';
                        resultDiv.innerHTML += '<br><small style="color: #6b99c2;">✓ Current seeds exactly at minimum</small>';
                        
                        applyButton.disabled = true;
                        applyButton.textContent = 'Already at Minimum';
                        applyButton.style.background = '#95a5a6';
                    } else {
                        resultDiv.style.borderColor = '#6b99c2';
                        resultDiv.style.background = 'rgba(107, 153, 194, 0.1)';
                        resultDiv.innerHTML += '<br><small style="color: #6b99c2;">✓ Current seeds adequate</small>';
                        
                        applyButton.disabled = false;
                        applyButton.textContent = `Use ${recommendedSeeds} Seeds`;
                        applyButton.style.background = '#6b99c2';
                    }
                }
                
            } catch (error) {
                const resultDiv = document.getElementById('sampleSizeResult');
                resultDiv.innerHTML = `<span style="color: #d4691e;">⚠️ ${error.message}</span>`;
                resultDiv.style.borderColor = '#d4691e';
                resultDiv.style.background = 'rgba(212, 105, 30, 0.1)';
            }
        }

        function applySampleSize() {
            if (recommendedSeeds > 0) {
                const numSeedsInput = document.getElementById('numSeeds');
                const oldValue = numSeedsInput.value;
                numSeedsInput.value = recommendedSeeds;
                
                // Add visual feedback class
                numSeedsInput.classList.add('seeds-updated');
                
                // Trigger change events to update other dependent calculations
                updateRuntimeDisplay();
                calculateSampleSize();
                
                // Remove visual feedback after 2 seconds
                setTimeout(() => {
                    numSeedsInput.classList.remove('seeds-updated');
                }, 2000);
                
                console.log(`Applied sample size: ${oldValue} → ${recommendedSeeds} seeds`);
            }
        }

        async function validateCapacity() {
            const token = localStorage.getItem('authToken');
            if (!token || !isValidToken(token)) {
                return;
            }

            const parameters = collectParameters();
            
            try {
                const apiUrl = window.API_CONFIG?.endpoints?.['carlift'] || 'https://4x66k1lppi.execute-api.us-east-1.amazonaws.com/api/carlift';
const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'validateCapacity',
                        parameters: parameters
                    })
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login/';
                    return;
                }

                const data = await response.json();
                
                if (data.success) {
                    const validation = data.validation;
                    const warningDiv = document.getElementById('utilizationWarning');
                    const messageSpan = document.getElementById('utilizationMessage');
                    const runButton = document.getElementById('runButton');
                    const utilizationDisplay = document.getElementById('utilizationDisplay');
                    
                    // Store for later use in results display
                    theoreticalMinUtilization = validation.minimum;
                    theoreticalMaxUtilization = validation.maximum;
                    
                    // Update utilisation display
                    utilizationDisplay.textContent = `${validation.minimum.toFixed(1)}% - ${validation.maximum.toFixed(1)}%`;
                    
                    if (validation.maxExceedsCapacity) {
                        warningDiv.style.display = 'block';
                        
                        if (validation.capacityExceeded) {
                            warningDiv.style.borderColor = '#d4691e';
                            warningDiv.style.background = 'rgba(212, 105, 30, 0.1)';
                            runButton.classList.add('btn-disabled');
                            runButton.disabled = true;
                            messageSpan.innerHTML = `<strong>Even optimal dispatching cannot handle this traffic load</strong>`;
                        } else {
                            warningDiv.style.borderColor = '#f39c12';
                            warningDiv.style.background = 'rgba(243, 156, 18, 0.1)';
                            runButton.classList.remove('btn-disabled');
                            runButton.disabled = false;
                            messageSpan.innerHTML = `<strong>Traffic may be manageable with optimal dispatching</strong>`;
                        }
                    } else {
                        warningDiv.style.display = 'none';
                        runButton.classList.remove('btn-disabled');
                        runButton.disabled = false;
                    }
                }
            } catch (error) {
                console.error('Capacity validation failed:', error);
            }
        }

        function collectParameters() {
            const numFloors = parseInt(document.getElementById('numFloors').value) || 2;
            const lobbyFloor = parseInt(document.getElementById('lobbyFloor').value) || 1;
            
            const arrivalRates = {};
            const departureRates = {};
            
            for (let f = 1; f <= numFloors; f++) {
                if (f === lobbyFloor) continue;
                const arrivalInput = document.getElementById(`arrivalRate${f}`);
                const departureInput = document.getElementById(`departureRate${f}`);
                if (arrivalInput) arrivalRates[f] = parseFloat(arrivalInput.value) || 0;
                if (departureInput) departureRates[f] = parseFloat(departureInput.value) || 0;
            }
            
            return {
                numFloors,
                lobbyFloor,
                simHours: parseFloat(document.getElementById('simHours').value),
                numSeeds: parseInt(document.getElementById('numSeeds').value),
                seedMode: document.getElementById('seedMode').value,
                doorOpenTime: parseFloat(document.getElementById('doorOpenTime').value),
                doorCloseTime: parseFloat(document.getElementById('doorCloseTime').value),
                enterTime: parseFloat(document.getElementById('enterTime').value),
                exitTime: parseFloat(document.getElementById('exitTime').value),
                verticalSpeed: parseFloat(document.getElementById('verticalSpeed').value),
                bufferTime: parseFloat(document.getElementById('bufferTime').value),
                minHeadway: parseFloat(document.getElementById('minHeadway').value),
                arrivalRates,
                departureRates
            };
        }

        function generateValidationCheck(result, parameters) {
            // Calculate input arrival rate for comparison
            let inputTrafficRate = 0;
            for (let f = 1; f <= result.numFloors; f++) {
                if (f === result.lobbyFloor) continue;
                inputTrafficRate += parameters.arrivalRates[f] || 0;
                inputTrafficRate += parameters.departureRates[f] || 0;
            }
            
            const marginOfError = parseFloat(document.getElementById('marginOfError').value) || 0.05;
            const error = Math.abs(inputTrafficRate - result.actualArrivalRate);
            const validationPassed = error <= marginOfError;
            
            return `
                <h4>${validationPassed ? '✅' : '⚠️'} Traffic Rate Validation</h4>
                <ul class="validation-list">
                    <li><strong>Expected:</strong> ${inputTrafficRate.toFixed(2)} cars/hr</li>
                    <li><strong>Actual:</strong> ${result.actualArrivalRate.toFixed(2)} cars/hr</li>
                    <li><strong>Error:</strong> ${error.toFixed(3)} cars/hr</li>
                    <li><strong>Status:</strong> ${validationPassed ? 'Rate validated successfully' : 'Rate outside margin'} (±${marginOfError})</li>
                </ul>
            `;
        }

        function displayResults(result, parameters) {
            const content = document.getElementById('resultsContent');
            const totalSimTime = result.simHours * 3600;
            const validationCheck = generateValidationCheck(result, parameters);
            
            // Build traffic rates summary for input display
            let trafficRatesSummary = '';
            for (let f = 1; f <= result.numFloors; f++) {
                if (f === result.lobbyFloor) continue;
                const arrivals = parameters.arrivalRates[f] || 0;
                const departures = parameters.departureRates[f] || 0;
                if (arrivals > 0 || departures > 0) {
                    trafficRatesSummary += `Floor ${f}: ${arrivals} + ${departures} cars/hr; `;
                }
            }
            trafficRatesSummary = trafficRatesSummary.slice(0, -2); // Remove last "; "
            
            let html = `
                <div class="cards-container" style="margin-bottom: 20px;">
                    <div class="card">
                        <h4 class="card-title">Input Parameters</h4>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                            <div style="font-size: 0.9rem; color: #495057;">
                                <strong style="color: #354e8d;">Model:</strong> Car Lift System (${result.numFloors} floors)
                            </div>
                            <div style="font-size: 0.9rem; color: #495057;">
                                <strong style="color: #354e8d;">Lobby Floor:</strong> ${result.lobbyFloor}
                            </div>
                            <div style="font-size: 0.9rem; color: #495057;">
                                <strong style="color: #354e8d;">Traffic Rates IN+OUT:</strong> ${trafficRatesSummary}
                            </div>
                            <div style="font-size: 0.9rem; color: #495057;">
                                <strong style="color: #354e8d;">Door Times:</strong> Open ${parameters.doorOpenTime}s, Close ${parameters.doorCloseTime}s
                            </div>
                            <div style="font-size: 0.9rem; color: #495057;">
                                <strong style="color: #354e8d;">Movement:</strong> Enter ${parameters.enterTime}s, Exit ${parameters.exitTime}s
                            </div>
                            <div style="font-size: 0.9rem; color: #495057;">
                                <strong style="color: #354e8d;">Travel:</strong> ${parameters.verticalSpeed}s/floor + ${parameters.bufferTime}s buffer
                            </div>
                            <div style="font-size: 0.9rem; color: #495057;">
                                <strong style="color: #354e8d;">Simulation:</strong> ${result.simHours.toFixed(0)}h × ${result.numSeeds} seeds
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        ${validationCheck}
                    </div>
                </div>
                
                <div class="tables-container" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="table-section" style="padding: 8px;">
                        <h4 style="color: #354e8d; margin-bottom: 8px; font-size: 1rem; font-weight: 600; text-align: center;">System Performance</h4>
                        <table class="metrics-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="text-align: left; font-weight: 600;">Cars Served/Hour</td>
                                    <td>${(result.served / result.simHours).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; font-weight: 600;">Min Utilisation</td>
                                    <td>${(theoreticalMinUtilization || 0).toFixed(2)}%</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; font-weight: 600;">Actual Utilisation</td>
                                    <td>${result.utilizationRate.toFixed(2)}%</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; font-weight: 600;">Max Utilisation</td>
                                    <td>${(theoreticalMaxUtilization || 0).toFixed(2)}%</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; font-weight: 600;">Total Cars Served</td>
                                    <td>${formatScientific(result.served * result.numSeeds)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; font-weight: 600;">Avg Trip Time</td>
                                    <td>${(result.avgServiceTime || 0).toFixed(1)}s</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="table-section" style="padding: 8px;">
                        <h4 style="color: #354e8d; margin-bottom: 8px; font-size: 1rem; font-weight: 600; text-align: center;">State Breakdown</h4>
                        <table class="metrics-table">
                            <thead>
                                <tr>
                                    <th>State</th>
                                    <th>% Time</th>
                                    <th>Min/hour</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Idle</td>
                                    <td>${(((result.stateTimeTracking?.IDLE || 0) / totalSimTime) * 100).toFixed(1)}%</td>
                                    <td>${((result.stateTimeTracking?.IDLE || 0) / result.simHours / 60).toFixed(1)}</td>
                                </tr>
                                <tr>
                                    <td>Opening</td>
                                    <td>${(((result.stateTimeTracking?.DOORS_OPENING || 0) / totalSimTime) * 100).toFixed(1)}%</td>
                                    <td>${((result.stateTimeTracking?.DOORS_OPENING || 0) / result.simHours / 60).toFixed(1)}</td>
                                </tr>
                                <tr>
                                    <td>Loading</td>
                                    <td>${(((result.stateTimeTracking?.LOADING || 0) / totalSimTime) * 100).toFixed(1)}%</td>
                                    <td>${((result.stateTimeTracking?.LOADING || 0) / result.simHours / 60).toFixed(1)}</td>
                                </tr>
                                <tr>
                                    <td>Closing</td>
                                    <td>${(((result.stateTimeTracking?.DOORS_CLOSING || 0) / totalSimTime) * 100).toFixed(1)}%</td>
                                    <td>${((result.stateTimeTracking?.DOORS_CLOSING || 0) / result.simHours / 60).toFixed(1)}</td>
                                </tr>
                                <tr>
                                    <td>Moving Empty</td>
                                    <td>${(((result.stateTimeTracking?.MOVING || 0) / totalSimTime) * 100).toFixed(1)}%</td>
                                    <td>${((result.stateTimeTracking?.MOVING || 0) / result.simHours / 60).toFixed(1)}</td>
                                </tr>
                                <tr>
                                    <td>Moving Full</td>
                                    <td>${(((result.stateTimeTracking?.TRAVELING || 0) / totalSimTime) * 100).toFixed(1)}%</td>
                                    <td>${((result.stateTimeTracking?.TRAVELING || 0) / result.simHours / 60).toFixed(1)}</td>
                                </tr>
                                <tr>
                                    <td>Exiting</td>
                                    <td>${(((result.stateTimeTracking?.EXITING || 0) / totalSimTime) * 100).toFixed(1)}%</td>
                                    <td>${((result.stateTimeTracking?.EXITING || 0) / result.simHours / 60).toFixed(1)}</td>
                                </tr>
                                <tr>
                                    <td>Leveling Buffer</td>
                                    <td>${(((result.stateTimeTracking?.LEVELING_BUFFER || 0) / totalSimTime) * 100).toFixed(1)}%</td>
                                    <td>${((result.stateTimeTracking?.LEVELING_BUFFER || 0) / result.simHours / 60).toFixed(1)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="table-section" style="padding: 8px;">
                        <h4 style="color: #354e8d; margin-bottom: 8px; font-size: 1rem; font-weight: 600; text-align: center;">Wait Times by Floor</h4>
                        <table class="metrics-table">
                            <thead>
                                <tr>
                                    <th>Floor</th>
                                    <th>Wait (s)</th>
                                    <th>Service (s)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            for (let f = 1; f <= result.numFloors; f++) {
                const waitTime = result.avgWaitTimesByFloor[f] || 0;
                const serviceTime = result.avgServiceTimesByFloor[f] || 0;
                const floorLabel = f === result.lobbyFloor ? `${f} (Lobby)` : `${f}`;
                
                if (waitTime > 0 || serviceTime > 0 || f === result.lobbyFloor) {
                    html += `
                        <tr>
                            <td>${floorLabel}</td>
                            <td>${waitTime > 0 ? waitTime.toFixed(0) : 'N/A'}</td>
                            <td>${serviceTime > 0 ? serviceTime.toFixed(0) : 'N/A'}</td>
                        </tr>
                    `;
                }
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tables-container" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); margin-top: 20px;">
            `;
            
            // Queue Length Distribution Tables with Hourly Maximum Distribution
            for (let f = 1; f <= result.numFloors; f++) {
                
                const hist = result.avgQueueStats[f] || {};
                const totalTime = Object.values(hist).reduce((a, b) => a + b, 0);
                
                if (totalTime > 0) {
                    html += `
                        <div class="table-section" style="padding: 8px;">
                            <h4 style="color: #354e8d; margin-bottom: 8px; font-size: 1rem; font-weight: 600; text-align: center;">Floor ${f} Queue Distribution</h4>
                            <table class="distribution-table">
                                <thead>
                                    <tr>
                                        <th>Cars in Queue</th>
                                        <th>% Time</th>
                                        <th>Cumulative</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Get all queue lengths and ensure 0 is included
                    const queueLengths = Object.keys(hist).map(k => parseInt(k)).sort((a, b) => a - b);
                    if (!queueLengths.includes(0)) {
                        queueLengths.unshift(0);
                    }
                    
                    let cumulative = 0;
                    
                    for (const qLen of queueLengths) {
                        const timeSpent = hist[qLen] || 0;
                        const pct = (timeSpent / totalTime * 100);
                        cumulative += pct;
                        
                        // Show all rows up to and including 99.99% cumulative
                        if (cumulative <= 99.99) {
                            html += `
                                <tr>
                                    <td>${qLen}</td>
                                    <td>${pct.toFixed(2)}%</td>
                                    <td>${cumulative.toFixed(2)}%</td>
                                </tr>
                            `;
                        }
                    }
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // Add hourly maximum distribution table for this floor
                const hourlyMaxDist = result.hourlyMaxDistributions && result.hourlyMaxDistributions[f] ? 
                    result.hourlyMaxDistributions[f] : {};
                
                if (Object.keys(hourlyMaxDist).length > 0 || result.hourlyMaxDistributions) {
                    html += `
                        <div class="table-section" style="padding: 8px;">
                            <h4 style="color: #354e8d; margin-bottom: 8px; font-size: 1rem; font-weight: 600; text-align: center;">Floor ${f} Hourly Maximum Distribution</h4>
                            <table class="distribution-table">
                                <thead>
                                    <tr>
                                        <th>Max Cars/Hour</th>
                                        <th>% Hours</th>
                                        <th>Cumulative</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Get all max values and ensure 0 is included
                    const sortedMaxes = Object.keys(hourlyMaxDist).map(m => parseInt(m)).sort((a, b) => a - b);
                    if (!sortedMaxes.includes(0)) {
                        sortedMaxes.unshift(0);
                    }
                    
                    let maxCumulative = 0;
                    for (const max of sortedMaxes) {
                        const percentage = hourlyMaxDist[max] ? hourlyMaxDist[max].avg : 0;
                        maxCumulative += percentage;
                        
                        // Show all rows up to and including 99.99% cumulative
                        if (maxCumulative <= 99.99) {
                            html += `
                                <tr>
                                    <td>${max}</td>
                                    <td>${percentage.toFixed(2)}%</td>
                                    <td>${maxCumulative.toFixed(2)}%</td>
                                </tr>
                            `;
                        }
                    }
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            }
            
            html += `</div>`;

            content.innerHTML = html;
        }

        async function runSimulation() {
            const token = localStorage.getItem('authToken');
            if (!token || !isValidToken(token)) {
                window.location.href = '/login/';
                return;
            }

            const runButton = document.getElementById('runButton');
            if (runButton.disabled) return;

            let parameters;
            try {
                parameters = collectParameters();
            } catch (error) {
                // Error already displayed by collectParameters
                return;
            }

            const resultsContent = document.getElementById('resultsContent');
            const status = document.getElementById('status');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressDetails = document.getElementById('progressDetails');

            // Get estimated runtime from common.js
            let estimatedMs;
            try {
                estimatedMs = estimateSimulationRuntime(parameters);
            } catch (error) {
                console.warn('Could not estimate runtime:', error);
                estimatedMs = 5000; // Default fallback
            }

            // Show loading state with estimated time
            runButton.disabled = true;
            const numSeeds = parameters.numSeeds;
            const estimatedTimeStr = formatEstimatedTime(estimatedMs);
            runButton.textContent = `Running Simulation...`;
            
            status.style.display = 'block';
            status.className = 'status running';
            status.textContent = `Running simulation...`;
            
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressPercentage.textContent = '0%';
            progressDetails.textContent = 'Initializing...';

            resultsContent.innerHTML = `
                <div class="no-results">
                    <h4>Running simulation...</h4>
                    <p>Processing ${numSeeds} seeds (estimated time: ${estimatedTimeStr})</p>
                </div>
            `;

            // Scroll to progress bar using common.js function
            scrollToProgress();

            // Start realistic progress animation from common.js
            const progressInterval = createRealisticProgress(estimatedMs, progressFill, progressPercentage, progressDetails);

            try {
                
                const startTime = Date.now();

                            const apiUrl = window.API_CONFIG?.endpoints?.['carlift'] || 'https://4x66k1lppi.execute-api.us-east-1.amazonaws.com/api/carlift';
const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'runSimulation',
                        parameters: parameters
                    })
                });

                clearInterval(progressInterval);

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login/';
                    return;
                }

                // Check if response is actually JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('Non-JSON response received:', textResponse);
                    throw new Error(`Server returned ${response.status}: ${textResponse.substring(0, 200)}...`);
                }

                const data = await response.json();
                const actualTime = Date.now() - startTime;

                if (data.success) {
                    // Complete the progress bar
                    progressFill.style.width = '100%';
                    progressPercentage.textContent = '100%';
                    progressDetails.textContent = 'Complete!';
                    
                    const actualTimeStr = formatEstimatedTime(actualTime);
                    
                    status.className = 'status complete';
                    status.textContent = `Simulation completed!`;
                    
                    displayResults(data.results, parameters);

                    // Scroll to results using common.js function after a brief delay to allow for DOM updates
                    setTimeout(() => {
                        scrollToResults();
                    }, 300);

                    setTimeout(() => {
                        status.style.display = 'none';
                        progressContainer.style.display = 'none';
                    }, 5000); // Show accuracy info longer

                } else {
                    throw new Error(data.error || 'Simulation failed');
                }

            } catch (error) {
                clearInterval(progressInterval);
                status.className = 'status error';
                status.textContent = 'Error: ' + error.message;
                console.error('Simulation error:', error);
                resultsContent.innerHTML = `
                    <div class="no-results">
                        <h4>Simulation Error</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            
                // Still scroll to results section even on error so user can see the error message
                setTimeout(() => {
                    scrollToResults();
                }, 300);
            }

            runButton.disabled = false;
            runButton.textContent = 'Run Simulation';
        }

        function resetForm() {
            document.getElementById('numFloors').value = 2;
            document.getElementById('lobbyFloor').value = 1;
            document.getElementById('simHours').value = 1000;
            document.getElementById('numSeeds').value = 15;
            document.getElementById('confidenceLevel').value = '99.9';
            document.getElementById('marginOfError').value = 0.5;
            document.getElementById('seedMode').value = 'fixed';
            
            document.getElementById('doorOpenTime').value = 5;
            document.getElementById('enterTime').value = 15;
            document.getElementById('doorCloseTime').value = 5;
            document.getElementById('verticalSpeed').value = 20;
            document.getElementById('exitTime').value = 15;
            document.getElementById('bufferTime').value = 2;
            document.getElementById('minHeadway').value = 3;
            
            // Clear any error styling
            document.querySelectorAll('input').forEach(input => {
                input.style.borderColor = '';
            });
            
            generateRateInputs();
            
            // Initialize displays in the correct order
            setTimeout(() => {
                updateTotalTraffic();
                validateCapacity();
                calculateSampleSize();
                updateRuntimeDisplay();
            }, 100);
            
            document.getElementById('resultsContent').innerHTML = `
                <div class="no-results">
                    <h4>Results will appear here</h4>
                    <p>Configure parameters and run simulation to see results</p>
                </div>
            `;
        }
    </script>
</body>
</html>