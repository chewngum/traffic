<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Labb - Car Park Simulation</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="module" src="/common.js"></script><script src="/utils/api-config.js"></script>
</head>
<body>
    <div id="loading" class="loading">
        <h2>Verifying access...</h2>
    </div>

    <div id="app" class="container hidden">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="header-title">
                    <h1>Car Park Simulation</h1>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="glass-card">
                <h3 class="section-title">Configuration</h3>
                
                <div class="cards-container">
                    <div class="card">
                        <div class="card-title">Traffic Parameters</div>
                        <div style="background: #e3f1f7; padding: 12px; border-radius: 6px; margin-bottom: 12px; text-align: center; border: 1px solid #a3c9e0;">
                            <div style="font-size: 0.9rem; margin-bottom: 6px; font-weight: 600;">System Analysis</div>
                            <div style="font-size: 1.2rem; margin: 8px 0; color: #354e8d; font-weight: bold;">Arrivals → Car Park System</div>
                            <div style="font-size: 0.8rem; color: #666;">Discrete Event Simulation</div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="arrivalRate">Arrival Rate (cars/hour):</label>
                                <input type="number" id="arrivalRate" value="30" min="0.1" step="0.01" onchange="updateWarnings(); calculateSampleSize(); updateRuntimeDisplay(); updateAnalyticalCalculations(); validateUtilization();">
                            </div>
                            <div class="form-group">
                                <label for="minHeadway">Min Headway (seconds):</label>
                                <input type="number" id="minHeadway" value="3" min="0" step="0.1" onchange="updateAnalyticalCalculations();">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="serviceTime">Mean Service Time (seconds):</label>
                                <input type="number" id="serviceTime" value="300" min="1" step="0.1" onchange="updateWarnings(); updateAnalyticalCalculations(); validateUtilization();">
                            </div>
                            <div class="form-group">
                                <label for="serviceTimeDistribution">Service Time Distribution:</label>
                                <select id="serviceTimeDistribution" onchange="updateServiceTimeLabel(); updateAnalyticalCalculations();">
                                    <option value="constant">Constant (Fixed Duration)</option>
                                    <option value="exponential" selected>Exponential (Variable Duration)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="spaces">Number of Spaces:</label>
                                <input type="number" id="spaces" value="10" min="1" onchange="updateWarnings(); updateRuntimeDisplay(); updateAnalyticalCalculations(); validateUtilization();">
                            </div>
                            <div class="form-group">
                                <label for="queueLength">Available Queue Length:</label>
                                <input type="number" id="queueLength" value="1000" min="0" onchange="updateAnalyticalCalculations();">
                            </div>
                        </div>
                        
                        <div class="validation-check" style="margin-top: 12px;">
                            <strong>Theoretical Min Spaces:</strong> <span id="theoreticalSpaces">2.50</span>
                        </div>
                        <div class="validation-check utilization-check">
                            <strong>Utilization Rate:</strong> <span id="utilizationDisplay">25.0%</span>
                        </div>
                        
                        <div id="warningMessage" class="alert-warning" style="display: none; margin-top: 12px;">
                            <strong>⚠️ System Overload Warning</strong><br>
                            Current spaces below theoretical minimum - system will be overloaded!
                        </div>
                        
                        <div id="utilizationWarning" class="utilization-warning" style="display: none; margin-top: 12px;">
                            <span id="utilizationMessage"></span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Theoretical Analysis</div>
                        <div style="background: #e3f1f7; padding: 12px; border-radius: 6px; margin-bottom: 12px; text-align: center; border: 1px solid #a3c9e0;">
                            <div style="font-size: 0.9rem; margin-bottom: 6px; font-weight: 600;">Queuing Theory Predictions</div>
                            <div style="font-size: 1.4rem; margin: 8px 0; color: #354e8d; font-weight: bold;">M/M/c Analysis</div>
                            <div style="font-size: 0.8rem; color: #666;">0s Headway Approximation</div>
                        </div>
                        
                        <div style="margin: 12px 0;">
                            <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; color: #354e8d;">Analytical Model Results</div>
                            
                            <div style="margin-bottom: 12px;">
                                <label for="analyticalPercentile" style="font-size: 0.9rem; font-weight: 600; color: #354e8d;">Analysis Percentile:</label>
                                <input type="number" id="analyticalPercentile" value="98" min="1" max="99.9" step="0.1" 
                                       style="margin-left: 8px; width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" 
                                       onchange="updateAnalyticalCalculations();">
                                <span style="font-size: 0.85rem; color: #666; margin-left: 4px;">%</span>
                            </div>
                            
                            <table id="analyticalTable" style="width: 100%; font-size: 0.85rem; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: left;">Model</th>
                                        <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">Parked</th>
                                        <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">Queueing</th>
                                        <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">Blocked</th>
                                        <th style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;">Pass/Fail</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 6px 8px; border: 1px solid #ddd;" id="erlangBModelName">Erlang-B (Blocking)</td>
                                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;" id="erlangBParked">-</td>
                                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;" id="erlangBQueueing">-</td>
                                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;" id="erlangBBlocked">-</td>
                                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;" id="erlangBPass">-</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 6px 8px; border: 1px solid #ddd;" id="mmcModelName">M/M/c (Queueing)</td>
                                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;" id="erlangCParked">-</td>
                                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;" id="erlangCQueueing">-</td>
                                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center;" id="erlangCBlocked">-</td>
                                        <td style="padding: 6px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;" id="erlangCPass">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div id="serviceTimeInfo" class="help-text" style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #6b99c2;">
                            <strong>Constant Service Time:</strong> All cars park for exactly the specified duration.
                        </div>
                    </div>
                    
                    <div class="form row">
                        <div class="form-group">
                            <div class="card sample-calculator">
                                <div class="card-title">Simulation Settings</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="confidenceLevel">Confidence Level (%):</label>
                                        <select id="confidenceLevel" onchange="calculateSampleSize()">
                                            <option value="90">90</option>
                                            <option value="95">95</option>
                                            <option value="99">99</option>
                                            <option value="99.9" selected>99.9</option>
                                            <option value="99.99">99.99</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="marginOfError">Margin of Error (cars/hour):</label>
                                        <input type="number" id="marginOfError" value="0.05" min="0.001" step="0.001" onchange="calculateSampleSize()">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="numSeeds">Number of Seeds:</label>
                                        <input type="number" id="numSeeds" value="130" min="1" max="10000" step="1" onchange="updateRuntimeDisplay()">
                                    </div>
                                    <div class="form-group">
                                        <label for="seedMode">Seed Mode:</label>
                                        <select id="seedMode">
                                            <option value="fixed" selected>Fixed (Reproducible)</option>
                                            <option value="random">Random</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="simulationHours">Simulation Hours:</label>
                                        <input type="number" id="simulationHours" value="1000" min="10" onchange="calculateSampleSize(); updateRuntimeDisplay();">
                                    </div>
                                    <div class="form-group">
                                        <label>Estimated Runtime:</label>
                                        <div id="runtimeEstimate" class="help-text" style="font-weight: 600;">Calculating...</div>
                                    </div>
                                </div>
                                <div id="sampleSizeResult" class="sample-result">
                                    Calculating minimum seeds...
                                </div>
                                
                                <div style="text-align: center; margin-top: 10px;">
                                    <button class="btn btn-secondary" onclick="applySampleSize()" style="padding: 6px 12px; font-size: 0.85rem;">Apply Calculated Seeds</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="buttons-row">
                    <button class="btn btn-reset" id="resetButton">Reset</button>
                    <button class="btn btn-run" id="runSimulation">Run Simulation</button>
                </div>
                
                <div class="status" id="status" style="display: none;"></div>
                <div class="progress-bar" id="progressContainer" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text">
                        <div id="progressPercentage">0%</div>
                        <div id="progressDetails">Initializing...</div>
                    </div>
                </div>
            </div>
            
            <div class="results-container" id="resultsSection">
                <h3 class="section-title">Results</h3>
                
                <div id="resultsContent">
                    <div class="no-results">
                        <h4>Results will appear here</h4>
                        <p>Configure parameters and run simulation to see results comparing three car park management strategies</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .utilization-check {
            margin-top: 8px;
        }

        .utilization-warning {
            padding: 12px;
            border-radius: 6px;
            border: 2px solid;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
        }

        .input-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
        }

        .input-summary h4 {
            margin: 0 0 12px 0;
            color: #354e8d;
            font-size: 1rem;
            font-weight: 600;
        }

        .input-summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }

        .input-group {
            font-size: 0.9rem;
            color: #495057;
        }

        .input-group strong {
            color: #354e8d;
            margin-right: 8px;
        }

        .results-cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .results-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
        }

        .results-card h4 {
            margin: 0 0 12px 0;
            color: #354e8d;
            font-size: 1rem;
            font-weight: 600;
        }

        .validation-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .validation-list li {
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #495057;
        }

        .validation-list li:last-child {
            margin-bottom: 0;
        }

        .validation-list strong {
            color: #354e8d;
            margin-right: 8px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 0.85rem;
        }

        .comparison-table thead tr {
            background: #f8f9fa;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .comparison-table th {
            font-weight: 600;
            color: #354e8d;
        }

        .comparison-table td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .comparison-section {
            margin-bottom: 24px;
        }

        .comparison-section h4 {
            color: #354e8d;
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .results-cards-container {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const token = localStorage.getItem('authToken');
            if (!token || !isValidToken(token)) {
                window.location.href = '/login/';
                return;
            }
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
            
            resetInputs();
            calculateSampleSize();
            updateWarnings();
            updateRuntimeDisplay();
            updateServiceTimeLabel();
            updateAnalyticalCalculations();
            validateUtilization();
        });

        function isValidToken(token) {
            try {
                const decoded = atob(token);
                const [timestamp, username] = decoded.split(':');
                const tokenAge = Date.now() - parseInt(timestamp);
                return tokenAge < 24 * 60 * 60 * 1000;
            } catch {
                return false;
            }
        }

        function validateUtilization() {
            try {
                const arrivalRate = parseFloat(document.getElementById('arrivalRate').value);
                const serviceTime = parseFloat(document.getElementById('serviceTime').value);
                const spaces = parseInt(document.getElementById('spaces').value);
                
                if (isNaN(arrivalRate) || isNaN(serviceTime) || isNaN(spaces) || spaces <= 0) {
                    document.getElementById('utilizationDisplay').textContent = 'N/A';
                    document.getElementById('utilizationWarning').style.display = 'none';
                    return;
                }
                
                const rho = arrivalRate * (serviceTime / 3600);
                const utilization = rho / spaces;
                const utilizationPercent = utilization * 100;
                
                document.getElementById('utilizationDisplay').textContent = utilizationPercent.toFixed(1) + '%';
                
                const warningDiv = document.getElementById('utilizationWarning');
                const messageSpan = document.getElementById('utilizationMessage');
                const runButton = document.getElementById('runSimulation');
                
                if (arrivalRate === 0) {
                    warningDiv.style.display = 'none';
                    runButton.disabled = false;
                    runButton.classList.remove('btn-disabled');
                } else if (utilizationPercent >= 100) {
                    warningDiv.style.display = 'block';
                    warningDiv.style.borderColor = '#d4691e';
                    warningDiv.style.background = 'rgba(212, 105, 30, 0.1)';
                    messageSpan.innerHTML = `⚠️ Utilization is ${utilizationPercent.toFixed(1)}%<br><strong>System overloaded - queues will grow indefinitely</strong>`;
                    runButton.disabled = false; // Allow run to demonstrate overload
                    runButton.classList.remove('btn-disabled');
                } else if (utilizationPercent >= 95) {
                    warningDiv.style.display = 'block';
                    warningDiv.style.borderColor = '#d4691e';
                    warningDiv.style.background = 'rgba(212, 105, 30, 0.1)';
                    messageSpan.innerHTML = `⚠️ Utilization is ${utilizationPercent.toFixed(1)}%<br><strong>Very high utilization - expect long queues and delays</strong>`;
                    runButton.disabled = false;
                    runButton.classList.remove('btn-disabled');
                } else if (utilizationPercent >= 80) {
                    warningDiv.style.display = 'block';
                    warningDiv.style.borderColor = '#f39c12';
                    warningDiv.style.background = 'rgba(243, 156, 18, 0.1)';
                    messageSpan.innerHTML = `⚠️ Utilization is ${utilizationPercent.toFixed(1)}%<br><strong>High utilization - moderate queuing expected</strong>`;
                    runButton.disabled = false;
                    runButton.classList.remove('btn-disabled');
                } else {
                    warningDiv.style.display = 'none';
                    runButton.disabled = false;
                    runButton.classList.remove('btn-disabled');
                }
                
            } catch (error) {
                document.getElementById('utilizationDisplay').textContent = 'N/A';
                document.getElementById('utilizationWarning').style.display = 'none';
            }
        }

        function updateServiceTimeLabel() {
            const distribution = document.getElementById('serviceTimeDistribution').value;
            const serviceTimeLabel = document.querySelector('label[for="serviceTime"]');
            const infoDiv = document.getElementById('serviceTimeInfo');
            
            if (distribution === 'exponential') {
                serviceTimeLabel.textContent = 'Mean Service Time (seconds):';
                infoDiv.innerHTML = '<strong>Exponential Service Time:</strong> Service times vary randomly around the mean, with some cars staying much longer or shorter than average.';
            } else {
                serviceTimeLabel.textContent = 'Service Time (seconds):';
                infoDiv.innerHTML = '<strong>Constant Service Time:</strong> All cars park for exactly the specified duration.';
            }
            updateAnalyticalCalculations();
        }

        function factorial(n) {
            if (n <= 1) return 1;
            if (n > 170) return Infinity;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        function calculateErlangB(rho, c) {
            if (rho <= 0 || c <= 0) return 0;
            if (rho >= c * 10) return 1;
            
            let logNumerator = c * Math.log(rho) - logFactorial(c);
            let logDenominator = -Infinity;
            
            for (let k = 0; k <= c; k++) {
                let logTerm = k * Math.log(rho) - logFactorial(k);
                logDenominator = logSum(logDenominator, logTerm);
            }
            
            let result = Math.exp(logNumerator - logDenominator);
            return Math.min(1, Math.max(0, result));
        }

        function logFactorial(n) {
            if (n <= 1) return 0;
            let result = 0;
            for (let i = 2; i <= n; i++) {
                result += Math.log(i);
            }
            return result;
        }

        function logSum(logA, logB) {
            if (logA === -Infinity) return logB;
            if (logB === -Infinity) return logA;
            let max = Math.max(logA, logB);
            let min = Math.min(logA, logB);
            return max + Math.log(1 + Math.exp(min - max));
        }

        function calculateMDcQueueProb(rho, c) {
            if (rho <= 0 || c <= 0) return 0;
            if (rho >= c) return 1;
            
            const mmcProb = calculateMMcQueueProb(rho, c);
            const utilization = rho / c;
            
            const varianceReduction = 0.5 + 0.5 * (1 - utilization);
            return Math.min(1, mmcProb * varianceReduction);
        }

        function calculatePercentileOccupancy(rho, c, percentile, modelType) {
            if (rho <= 0 || c <= 0 || percentile <= 0 || percentile >= 100) {
                return { parked: 0, queueing: 0, blocked: 0 };
            }
            
            const targetProb = percentile / 100;
            
            if (modelType === 'erlangB') {
                const blockingProb = calculateErlangB(rho, c);
                
                let stateProbs = [];
                let sum = 0;
                
                for (let k = 0; k <= c; k++) {
                    const prob = Math.pow(rho, k) / factorial(k);
                    stateProbs[k] = prob;
                    sum += prob;
                }
                
                for (let k = 0; k <= c; k++) {
                    stateProbs[k] /= sum;
                }
                
                let cumProb = 0;
                let percentileOccupancy = 0;
                
                for (let k = 0; k <= c; k++) {
                    const prevCumProb = cumProb;
                    cumProb += stateProbs[k];
                    
                    if (cumProb >= targetProb) {
                        if (k > 0 && prevCumProb < targetProb && stateProbs[k] > 0) {
                            const fraction = (targetProb - prevCumProb) / stateProbs[k];
                            percentileOccupancy = (k - 1) + fraction;
                        } else {
                            percentileOccupancy = k;
                        }
                        break;
                    }
                }
                
                return {
                    parked: percentileOccupancy,
                    queueing: 0,
                    blocked: blockingProb * 100
                };
                
            } else if (modelType === 'mmc') {
                if (rho >= c) {
                    return { parked: c, queueing: 1000, blocked: 0 };
                }
                
                let sum = 0;
                for (let k = 0; k < c; k++) {
                    sum += Math.pow(rho, k) / factorial(k);
                }
                sum += Math.pow(rho, c) / factorial(c) * c / (c - rho);
                
                const P0 = 1 / sum;
                
                let cumProb = 0;
                let percentileTotal = 0;
                
                for (let k = 0; k < c; k++) {
                    const prevCumProb = cumProb;
                    const prob = Math.pow(rho, k) / factorial(k) * P0;
                    cumProb += prob;
                    
                    if (cumProb >= targetProb) {
                        if (k > 0 && prevCumProb < targetProb && prob > 0) {
                            const fraction = (targetProb - prevCumProb) / prob;
                            percentileTotal = (k - 1) + fraction;
                        } else {
                            percentileTotal = k;
                        }
                        break;
                    }
                }
                
                if (cumProb < targetProb) {
                    const probBase = Math.pow(rho, c) / factorial(c) * P0;
                    
                    for (let n = c; n <= c + 200; n++) {
                        const prevCumProb = cumProb;
                        const prob = probBase * Math.pow(rho / c, n - c);
                        cumProb += prob;
                        
                        if (cumProb >= targetProb || prob < 1e-10) {
                            if (prevCumProb < targetProb && prob > 1e-10) {
                                const fraction = (targetProb - prevCumProb) / prob;
                                percentileTotal = (n - 1) + fraction;
                            } else {
                                percentileTotal = n;
                            }
                            break;
                        }
                    }
                }
                
                const parked = Math.min(c, percentileTotal);
                const queueing = Math.max(0, percentileTotal - c);
                
                return {
                    parked: parked,
                    queueing: queueing,
                    blocked: 0
                };
            }
            
            return { parked: 0, queueing: 0, blocked: 0 };
        }

        function calculateMMcQueueProb(rho, c) {
            if (rho <= 0 || c <= 0) return 0;
            if (rho >= c) return 1;
            
            try {
                let logRhoCOverCFactorial = c * Math.log(rho) - logFactorial(c);
                let logCOverCMinusRho = Math.log(c) - Math.log(c - rho);
                
                let logNumerator = logRhoCOverCFactorial + logCOverCMinusRho;
                
                let logDenominator = -Infinity;
                for (let k = 0; k < c; k++) {
                    let logTerm = k * Math.log(rho) - logFactorial(k);
                    logDenominator = logSum(logDenominator, logTerm);
                }
                logDenominator = logSum(logDenominator, logRhoCOverCFactorial + logCOverCMinusRho);
                
                let result = Math.exp(logNumerator - logDenominator);
                return Math.min(1, Math.max(0, result));
            } catch (error) {
                return rho >= c ? 1 : 0;
            }
        }

        function updateAnalyticalCalculations() {
            try {
                const arrivalRate = parseFloat(document.getElementById('arrivalRate').value);
                const serviceTime = parseFloat(document.getElementById('serviceTime').value);
                const spaces = parseInt(document.getElementById('spaces').value);
                const queueLength = parseInt(document.getElementById('queueLength').value);
                const serviceDistribution = document.getElementById('serviceTimeDistribution').value;
                const percentile = parseFloat(document.getElementById('analyticalPercentile').value);
                
                const rho = arrivalRate * (serviceTime / 3600);
                
                const erlangBResults = calculatePercentileOccupancy(rho, spaces, percentile, 'erlangB');
                const mmcResults = calculatePercentileOccupancy(rho, spaces, percentile, 'mmc');
                
                const isConstant = serviceDistribution === 'constant';
                const erlangBModelName = document.getElementById('erlangBModelName');
                const mmcModelName = document.getElementById('mmcModelName');
                
                if (isConstant) {
                    erlangBModelName.innerHTML = 'Erlang-B (Blocking) <span style="color: #d4691e; font-size: 0.75rem;">*approx</span>';
                    mmcModelName.innerHTML = 'M/M/c (Queueing) <span style="color: #d4691e; font-size: 0.75rem;">*approx</span>';
                } else {
                    erlangBModelName.textContent = 'Erlang-B (Blocking)';
                    mmcModelName.textContent = 'M/M/c (Queueing)';
                }
                
                document.getElementById('erlangBParked').textContent = erlangBResults.parked.toFixed(1);
                document.getElementById('erlangBQueueing').textContent = erlangBResults.queueing.toFixed(2);
                document.getElementById('erlangBBlocked').textContent = erlangBResults.blocked.toFixed(1) + '%';
                
                document.getElementById('erlangCParked').textContent = mmcResults.parked.toFixed(1);
                document.getElementById('erlangCQueueing').textContent = mmcResults.queueing.toFixed(2);
                document.getElementById('erlangCBlocked').textContent = mmcResults.blocked.toFixed(1) + '%';
                
                const blockingThreshold = 100 - percentile;
                const erlangBPass = erlangBResults.blocked <= blockingThreshold;
                
                const mmcTotalDemand = mmcResults.parked + mmcResults.queueing;
                const mmcPass = mmcTotalDemand <= spaces;
                
                document.getElementById('erlangBPass').innerHTML = erlangBPass ? 
                    '<span style="color: #28a745;">✓</span>' : '<span style="color: #dc3545;">✗</span>';
                document.getElementById('erlangCPass').innerHTML = mmcPass ? 
                    '<span style="color: #28a745;">✓</span>' : '<span style="color: #dc3545;">✗</span>';
                
            } catch (error) {
                console.error('Error in analytical calculations:', error);
                document.getElementById('erlangBParked').textContent = '-';
                document.getElementById('erlangBQueueing').textContent = '-';
                document.getElementById('erlangBBlocked').textContent = '-';
                document.getElementById('erlangBPass').textContent = '-';
                document.getElementById('erlangCParked').textContent = '-';
                document.getElementById('erlangCQueueing').textContent = '-';
                document.getElementById('erlangCBlocked').textContent = '-';
                document.getElementById('erlangCPass').textContent = '-';
            }
        }

        function collectParameters() {
            return {
                arrivalRate: parseFloat(document.getElementById('arrivalRate').value),
                serviceTime: parseFloat(document.getElementById('serviceTime').value) / 3600,
                serviceTimeDistribution: document.getElementById('serviceTimeDistribution').value,
                totalSpaces: parseInt(document.getElementById('spaces').value),
                spaces: parseInt(document.getElementById('spaces').value),
                queueLength: parseInt(document.getElementById('queueLength').value),
                simulationHours: parseFloat(document.getElementById('simulationHours').value),
                simHours: parseFloat(document.getElementById('simulationHours').value),
                numSeeds: parseInt(document.getElementById('numSeeds').value),
                minHeadway: parseFloat(document.getElementById('minHeadway').value) / 3600,
                seedMode: document.getElementById('seedMode').value
            };
        }

        function updateRuntimeDisplay() {
            try {
                const parameters = collectParameters();
                const estimatedMs = estimateCarParkRuntime(parameters);
                updateRuntimeEstimateDisplay(parameters, estimatedMs);
            } catch (error) {
                console.warn('Could not update runtime display:', error);
            }
        }

        function estimateCarParkRuntime(parameters) {
            const arrivalRate = parameters.arrivalRate;
            const simHours = parameters.simHours || parameters.simulationHours;
            const numSeeds = parameters.numSeeds;
            
            const distributionMultiplier = parameters.serviceTimeDistribution === 'exponential' ? 1.1 : 1.0;
            
            const estimatedSeconds = arrivalRate * simHours * numSeeds * 0.0000016 * distributionMultiplier + 0.6;
            return Math.max(0.6, estimatedSeconds * 1000);
        }

        function updateRuntimeEstimateDisplay(parameters, estimatedMs = null) {
            const runtimeEstimateDiv = document.getElementById('runtimeEstimate');
            if (!runtimeEstimateDiv) return;
            
            try {
                const timeMs = estimatedMs || estimateSimulationRuntime(parameters);
                const timeStr = formatEstimatedTime(timeMs);
                runtimeEstimateDiv.textContent = timeStr;
                runtimeEstimateDiv.style.color = timeMs > 30000 ? '#d4691e' : '#6b99c2';
            } catch (error) {
                runtimeEstimateDiv.textContent = 'Unable to estimate';
                runtimeEstimateDiv.style.color = '#999';
            }
        }

        function calculateSampleSize() {
            const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
            const marginOfError = parseFloat(document.getElementById('marginOfError').value);
            const arrivalRate = parseFloat(document.getElementById('arrivalRate').value);
            const simulationHours = parseFloat(document.getElementById('simulationHours').value);
            
            const zScores = { 90: 1.645, 95: 1.96, 99: 2.576, 99.9: 3.291, 99.99: 3.891 };
            const z = zScores[confidenceLevel];
            const estimatedSigma = Math.sqrt(arrivalRate / simulationHours);
            const requiredSeeds = Math.ceil(Math.pow((z * estimatedSigma) / marginOfError, 2));
            
            const resultDiv = document.getElementById('sampleSizeResult');
            const currentSeeds = parseInt(document.getElementById('numSeeds').value);
            
            resultDiv.innerHTML = `
                <strong>Minimum ${requiredSeeds} seeds required</strong><br>
                <small>(Z=${z}, Est. σ=${estimatedSigma.toFixed(3)})</small>
            `;
            
            if (currentSeeds < requiredSeeds) {
                resultDiv.style.borderColor = '#a3c9e0';
                resultDiv.style.background = 'rgba(163, 201, 224, 0.1)';
            } else {
                resultDiv.style.borderColor = '#6b99c2';
                resultDiv.style.background = 'rgba(107, 153, 194, 0.1)';
                resultDiv.innerHTML += '<br><small style="color: #6b99c2;">✅ Current seeds adequate</small>';
            }
        }

        function applySampleSize() {
            const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
            const marginOfError = parseFloat(document.getElementById('marginOfError').value);
            const arrivalRate = parseFloat(document.getElementById('arrivalRate').value);
            const simulationHours = parseFloat(document.getElementById('simulationHours').value);
            
            const zScores = { 90: 1.645, 95: 1.96, 99: 2.576, 99.9: 3.291, 99.99: 3.891 };
            const z = zScores[confidenceLevel];
            const estimatedSigma = Math.sqrt(arrivalRate / simulationHours);
            const requiredSeeds = Math.ceil(Math.pow((z * estimatedSigma) / marginOfError, 2));
            
            document.getElementById('numSeeds').value = requiredSeeds;
            document.getElementById('seedMode').value = 'fixed';
            calculateSampleSize();
            updateRuntimeDisplay();
        }

        function updateWarnings() {
            const arrivalRate = parseFloat(document.getElementById('arrivalRate').value);
            const serviceTime = parseFloat(document.getElementById('serviceTime').value);
            const currentSpaces = parseInt(document.getElementById('spaces').value);
            
            const theoreticalMin = arrivalRate * serviceTime / 3600;
            
            document.getElementById('theoreticalSpaces').textContent = `${theoreticalMin.toFixed(2)} (${Math.ceil(theoreticalMin)})`;
            
            const spacesInput = document.getElementById('spaces');
            const runButton = document.getElementById('runSimulation');
            const warningMessage = document.getElementById('warningMessage');
            
            if (currentSpaces < theoreticalMin) {
                spacesInput.style.borderColor = '#dc3545';
                runButton.className = 'btn btn-warning';
                warningMessage.style.display = 'block';
            } else {
                spacesInput.style.borderColor = '';
                runButton.className = 'btn btn-run';
                warningMessage.style.display = 'none';
            }
        }

        function resetInputs() {
            document.getElementById('arrivalRate').value = '30';
            document.getElementById('serviceTime').value = '300';
            document.getElementById('serviceTimeDistribution').value = 'constant';
            document.getElementById('spaces').value = '10';
            document.getElementById('queueLength').value = '1000';
            document.getElementById('minHeadway').value = '3';
            document.getElementById('simulationHours').value = '1000';
            document.getElementById('numSeeds').value = '130';
            document.getElementById('confidenceLevel').value = '99.9';
            document.getElementById('marginOfError').value = '0.05';
            document.getElementById('seedMode').value = 'fixed';
            
            calculateSampleSize();
            updateWarnings();
            updateRuntimeDisplay();
            updateServiceTimeLabel();
            validateUtilization();
        }

        function generateValidationCheck(results, params) {
            const expectedRate = params.arrivalRate;
            const marginError = parseFloat(document.getElementById('marginOfError').value);
            
            const models = [
                { key: 'infinite', name: 'Infinite Capacity' },
                { key: 'blocking', name: 'Blocking Model' }, 
                { key: 'queuing', name: 'Queuing Model' }
            ];
            
            let validationHtml = '<h4>Arrival Rate Validation</h4><ul class="validation-list">';
            
            for (const model of models) {
                const result = results[model.key];
                if (!result) continue;
                
                const actualRate = result.actualArrivalRate;
                const difference = Math.abs(expectedRate - actualRate);
                const withinMargin = difference <= marginError;
                const statusIcon = withinMargin ? '✅' : '⚠️';
                
                validationHtml += `<li><strong>${model.name}:</strong> Expected ${expectedRate.toFixed(2)}, Actual ${actualRate.toFixed(2)}, Error ${difference.toFixed(3)} ${statusIcon}</li>`;
            }
            
            validationHtml += '</ul>';
            return validationHtml;
        }

        function displayResults(results, params) {
            const container = document.getElementById('resultsContent');
            
            const distributionText = params.serviceTimeDistribution === 'exponential' ? 
                '(exponential service time)' : '(constant service time)';
            
            let html = `
                <div class="results-cards-container">
                    <div class="input-summary">
                        <h4>Input Parameters</h4>
                        <div class="input-summary-grid">
                            <div class="input-group">
                                <strong>Model:</strong> Car Park System
                            </div>
                            <div class="input-group">
                                <strong>Arrival Rate:</strong> ${params.arrivalRate} cars/hr
                            </div>
                            <div class="input-group">
                                <strong>Service Time:</strong> ${(params.serviceTime * 3600).toFixed(1)}s ${distributionText}
                            </div>
                            <div class="input-group">
                                <strong>Spaces:</strong> ${params.spaces}
                            </div>
                            <div class="input-group">
                                <strong>Queue Length:</strong> ${params.queueLength}
                            </div>
                            <div class="input-group">
                                <strong>Min Headway:</strong> ${(params.minHeadway * 3600).toFixed(1)}s
                            </div>
                            <div class="input-group">
                                <strong>Simulation:</strong> ${params.simulationHours}h × ${params.numSeeds} seeds
                            </div>
                        </div>
                    </div>
                    
                    <div class="results-card">
                        ${generateValidationCheck(results, params)}
                    </div>
                </div>
                
                <div class="comparison-section">
                    <h4>Occupancy Percentiles (Parked|Queued)</h4>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Percentile</th>
                                <th>Infinite Capacity</th>
                                <th>Blocking Model</th>
                                <th>Queuing Model</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const percentiles = [10, 20, 30, 40, 50, 60, 70, 80, 90, 95, 98, 99];
            const models = ['infinite', 'blocking', 'queuing'];
            
            for (const p of percentiles) {
                html += `<tr><td>${p}%</td>`;
                
                for (const modelKey of models) {
                    const result = results[modelKey];
                    if (result && result.percentiles.parked[p] !== undefined) {
                        const parked = result.percentiles.parked[p];
                        const queued = result.percentiles.queued[p];
                        html += `<td>${parked.toFixed(0)}|${queued.toFixed(0)}</td>`;
                    } else {
                        html += `<td>-</td>`;
                    }
                }
                html += `</tr>`;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="comparison-section">
                    <h4>Performance Metrics Comparison</h4>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Infinite Capacity</th>
                                <th>Blocking Model</th>
                                <th>Queuing Model</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const metrics = [
                { 
                    key: 'expectedArrivalRate', 
                    label: 'Expected Arrival Rate (cars/hour)', 
                    format: (v) => v.toFixed(2),
                    show: { infinite: true, blocking: true, queuing: true }
                },
                { 
                    key: 'actualArrivalRate', 
                    label: 'Actual Arrival Rate (cars/hour)', 
                    format: (v) => v.toFixed(2),
                    show: { infinite: true, blocking: true, queuing: true }
                },
                { 
                    key: 'blockedPercentage', 
                    label: 'Cars Blocked (%)', 
                    format: (v) => v.toFixed(2) + '%',
                    show: { infinite: false, blocking: true, queuing: true }
                },
                { 
                    key: 'queuedPercentage', 
                    label: 'Cars That Queued (%)', 
                    format: (v) => v.toFixed(2) + '%',
                    show: { infinite: false, blocking: false, queuing: true }
                },
                { 
                    key: 'avgQueueTimePerArrival', 
                    label: 'Avg Queue Time per Arrival (sec)', 
                    format: (v) => (v * 3600).toFixed(2),
                    show: { infinite: false, blocking: false, queuing: true }
                },
                { 
                    key: 'avgQueueTimePerQueued', 
                    label: 'Avg Queue Time per Queued Car (sec)', 
                    format: (v) => (v * 3600).toFixed(2),
                    show: { infinite: false, blocking: false, queuing: true }
                }
            ];
            
            for (const metric of metrics) {
                html += `<tr><td>${metric.label}</td>`;
                
                for (const modelKey of models) {
                    const result = results[modelKey];
                    
                    if (!metric.show[modelKey]) {
                        html += `<td>-</td>`;
                    } else if (result && result[metric.key] !== undefined) {
                        html += `<td>${metric.format(result[metric.key])}</td>`;
                    } else {
                        html += `<td>-</td>`;
                    }
                }
                html += `</tr>`;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        document.getElementById('resetButton').addEventListener('click', resetInputs);

        document.getElementById('runSimulation').addEventListener('click', async () => {
            const token = localStorage.getItem('authToken');
            if (!token || !isValidToken(token)) {
                window.location.href = '/login/';
                return;
            }

            const runButton = document.getElementById('runSimulation');
            if (runButton.disabled) return;

            const parameters = collectParameters();
            const estimatedMs = estimateCarParkRuntime(parameters);
            const numSeeds = parameters.numSeeds;

            const elements = {
                status: document.getElementById('status'),
                progressContainer: document.getElementById('progressContainer'),
                progressFill: document.getElementById('progressFill'),
                progressPercentage: document.getElementById('progressPercentage'),
                progressDetails: document.getElementById('progressDetails'),
                resultsContent: document.getElementById('resultsContent')
            };

            runButton.disabled = true;
            runButton.textContent = `Running simulation...`;
            elements.status.style.display = 'block';
            elements.status.className = 'status running';
            elements.status.textContent = `Running simulation...`;
            elements.progressContainer.style.display = 'block';
            elements.resultsContent.innerHTML = `<div class="no-results"><h4>Running simulation...</h4><p>Processing ${numSeeds} seeds</p></div>`;

            scrollToProgress();

            const progressInterval = createRealisticProgress(estimatedMs, elements.progressFill, elements.progressPercentage, elements.progressDetails);
            const startTime = Date.now();

            try {
                            const apiUrl = window.API_CONFIG?.endpoints?.carparkutilisation || 'https://4x66k1lppi.execute-api.us-east-1.amazonaws.com/api/carparutilisation';
const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ action: 'runSimulation', parameters })
                });

                clearInterval(progressInterval);

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login/';
                    return;
                }

                if (!response.headers.get('content-type')?.includes('application/json')) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Simulation failed');

                const actualTime = Date.now() - startTime;
                
                elements.progressFill.style.width = '100%';
                elements.progressPercentage.textContent = '100%';
                elements.progressDetails.textContent = 'Complete!';
                elements.status.className = 'status complete';
                elements.status.textContent = `Completed!`;
                
                displayResults(data.results, parameters);

                setTimeout(() => {
                    scrollToResults();
                }, 300);

                setTimeout(() => {
                    elements.status.style.display = 'none';
                    elements.progressContainer.style.display = 'none';
                }, 4000);

            } catch (error) {
                clearInterval(progressInterval);
                elements.status.className = 'status error';
                elements.status.textContent = 'Error: ' + error.message;
                elements.resultsContent.innerHTML = `<div class="no-results"><h4>Error</h4><p>${error.message}</p></div>`;
                
                setTimeout(() => {
                    scrollToResults();
                }, 300);
            }

            runButton.disabled = false;
            runButton.textContent = 'Run Simulation';
        });
    </script>
</body>
</html>