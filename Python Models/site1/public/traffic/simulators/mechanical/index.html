<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Labb - Mechanical Parking</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="module" src="/common.js"></script><script src="/utils/api-config.js"></script>
</head>
<body>
    <div id="loading" class="loading">
        <h2>Verifying access...</h2>
    </div>

    <div id="app" class="container hidden">
        <div class="dashboard-header">
            <div class="header-left">
                <div class="header-title">
                    <h1>Mechanical Parking Simulation</h1>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="glass-card">
                <h3 class="section-title">Configuration</h3>
                
                <div class="cards-container">
                    <div class="card">
                        <div class="card-title">Traffic Flow</div>
                        <div style="background: #e3f1f7; padding: 12px; border-radius: 6px; margin-bottom: 12px; text-align: center; border: 1px solid #a3c9e0;">
                            <div style="font-size: 0.9rem; margin-bottom: 6px; font-weight: 600;">System Model</div>
                            <div style="font-size: 1.2rem; margin: 8px 0; color: #354e8d; font-weight: bold;">Entry Queue → Lift System ← Exit Queue</div>
                            <div style="font-size: 0.8rem; color: #666;">Automated Vehicle Storage/Retrieval</div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="entryRate">Entry Rate (cars/hour):</label>
                                <input type="number" id="entryRate" value="15" min="0" step="0.1" onchange="validateUtilization(); calculateSampleSize(); updateRuntimeDisplay()">
                            </div>
                            <div class="form-group">
                                <label for="exitRate">Exit Rate (cars/hour):</label>
                                <input type="number" id="exitRate" value="15" min="0" step="0.1" onchange="validateUtilization(); calculateSampleSize(); updateRuntimeDisplay()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="priority">Priority Mode:</label>
                            <select id="priority">
                                <option value="FCFS">First Come First Served</option>
                                <option value="CARS">Entry Priority</option>
                                <option value="PEOPLE">Exit Priority</option>
                            </select>
                            <div class="help-text">How the system prioritizes conflicting requests</div>
                        </div>
                        <div class="validation-check">
                            <strong>Total Traffic Rate:</strong> <span id="totalTrafficDisplay">30.0</span> cars/hour
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Service Parameters</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="entryServiceTime">Entry Service (seconds):</label>
                                <input type="number" id="entryServiceTime" value="5.4" min="0.1" step="0.1" onchange="validateUtilization()">
                                <div class="help-text">Time to complete entry operations</div>
                            </div>
                            <div class="form-group">
                                <label for="exitServiceTime">Exit Service (seconds):</label>
                                <input type="number" id="exitServiceTime" value="5.4" min="0.1" step="0.1" onchange="validateUtilization()">
                                <div class="help-text">Time to complete exit operations</div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="entryHeadway">Min Entry Headway (s):</label>
                                <input type="number" id="entryHeadway" value="0" min="0" step="0.1">
                                <div class="help-text">Minimum time between entry arrivals</div>
                            </div>
                            <div class="form-group">
                                <label for="exitHeadwayMode">Exit Headway Mode:</label>
                                <select id="exitHeadwayMode" onchange="toggleExitHeadway()">
                                    <option value="same">Same as Entry</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" id="exitHeadwayGroup" style="display: none;">
                            <label for="exitHeadway">Exit Min Headway (seconds):</label>
                            <input type="number" id="exitHeadway" value="0" min="0" step="0.1">
                            <div class="help-text">Minimum time between exit arrivals</div>
                        </div>
                        <div class="validation-check utilization-check">
                            <strong>Estimated Utilisation:</strong> <span id="utilizationDisplay">N/A</span>
                        </div>
                        <div id="utilizationWarning" class="utilization-warning" style="display: none;">
                            <span id="utilizationMessage"></span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Simulation Settings</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="simulationHours">Simulation Hours:</label>
                                <input type="number" id="simulationHours" value="1000" min="10" step="10" onchange="calculateSampleSize(); updateRuntimeDisplay()">
                            </div>
                            <div class="form-group">
                                <label for="numSeeds">Number of Seeds:</label>
                                <input type="number" id="numSeeds" value="15" min="1" step="1" onchange="updateRuntimeDisplay(); calculateSampleSize()">
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label for="seedMode">Seed Mode:</label>
                                <select id="seedMode">
                                    <option value="fixed" selected>Fixed (Reproducible)</option>
                                    <option value="random">Random</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Estimated Runtime:</label>
                            <div id="runtimeEstimate" class="help-text" style="font-weight: 600;">Calculating...</div>
                        </div>
                    </div>

                    <div class="card sample-calculator">
                        <div class="card-title">Sample Size Calculator</div>
                        <p style="margin-bottom: 6px; font-size: 0.85rem; color: #666;">Calculate minimum seeds for statistical confidence</p>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="confidenceLevel">Confidence Level:</label>
                                <select id="confidenceLevel" onchange="calculateSampleSize()">
                                    <option value="90">90%</option>
                                    <option value="95">95%</option>
                                    <option value="99">99%</option>
                                    <option value="99.9" selected>99.9%</option>
                                    <option value="99.99">99.99%</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="marginOfError">Margin of Error (% of trips):</label>
                                <input type="number" id="marginOfError" value="0.5" min="0.001" step="0.1" onchange="calculateSampleSize()">
                            </div>
                        </div>
                        
                        <div id="sampleSizeResult" class="sample-result">
                            Calculating minimum seeds...
                        </div>
                        
                        <div class="sample-actions">
                            <button id="applySampleSize" class="btn-apply-sample">
                                Use Minimum Seeds
                            </button>
                            <div class="current-seeds-info">
                                Current: <span id="currentSeedsDisplay">15</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="buttons-row">
                    <button class="btn btn-reset" id="resetButton">Reset Inputs</button>
                    <button class="btn btn-run" id="runSimulation">Run Simulation</button>
                </div>
                
                <div class="status" id="status" style="display: none;"></div>
                <div class="progress-bar" id="progressContainer" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text">
                        <div id="progressPercentage">0%</div>
                        <div id="progressDetails">Initializing...</div>
                    </div>
                </div>
            </div>
            
            <div class="results-container" id="resultsSection">
                <h3 class="section-title">Results</h3>
                
                <div id="resultsContent">
                    <div class="no-results">
                        <h4>Results will appear here</h4>
                        <p>Configure parameters and run simulation to see results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .sample-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: center;
        }

        .btn-apply-sample {
            background: #6b99c2;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            flex: 1;
            max-width: 150px;
        }

        .btn-apply-sample:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-apply-sample:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .sample-result {
            padding: 12px;
            border: 2px solid #a3c9e0;
            border-radius: 6px;
            background: rgba(163, 201, 224, 0.1);
            text-align: center;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }

        .current-seeds-info {
            font-size: 0.75rem;
            color: #666;
            text-align: right;
            flex: 1;
        }

        #currentSeedsDisplay {
            font-weight: 600;
            color: #354e8d;
        }

        .seeds-updated {
            background: #e8f5e8 !important;
            border-color: #6b99c2 !important;
            transition: all 0.3s ease;
        }

        .utilization-check {
            margin-top: 8px;
        }

        .utilization-warning {
            margin-top: 12px;
            padding: 12px;
            border-radius: 6px;
            border: 2px solid;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
        }

        .btn-disabled {
            background: #95a5a6 !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }

        .btn-disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .input-summary {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
        }

        .input-summary h4 {
            margin: 0 0 12px 0;
            color: #354e8d;
            font-size: 1rem;
            font-weight: 600;
        }

        .input-summary-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }

        .input-group {
            font-size: 0.9rem;
            color: #495057;
        }

        .input-group strong {
            color: #354e8d;
            margin-right: 8px;
        }

        .results-cards-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .results-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 16px;
        }

        .results-card h4 {
            margin: 0 0 12px 0;
            color: #354e8d;
            font-size: 1rem;
            font-weight: 600;
        }

        .validation-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .validation-list li {
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #495057;
        }

        .validation-list li:last-child {
            margin-bottom: 0;
        }

        .validation-list strong {
            color: #354e8d;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .results-cards-container {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
    </style>

    <script>
        let recommendedSeeds = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const token = localStorage.getItem('authToken');
            if (!token || !isValidToken(token)) {
                window.location.href = '/login/';
                return;
            }
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
            
            resetInputs();
            updateTotalTraffic();
            validateUtilization();
            calculateSampleSize();
            updateRuntimeDisplay();
            
            document.getElementById('applySampleSize').addEventListener('click', applySampleSize);
        });

        function isValidToken(token) {
            try {
                const decoded = atob(token);
                const [timestamp, username] = decoded.split(':');
                const tokenAge = Date.now() - parseInt(timestamp);
                return tokenAge < 24 * 60 * 60 * 1000;
            } catch {
                return false;
            }
        }

        function validateAndParseFloat(elementId, min = 0, max = Infinity, defaultValue = null) {
            const element = document.getElementById(elementId);
            const value = parseFloat(element.value);
            
            if (isNaN(value)) {
                if (defaultValue !== null) {
                    element.value = defaultValue;
                    element.style.borderColor = '';
                    return defaultValue;
                } else {
                    element.style.borderColor = '#d4691e';
                    throw new Error(`Invalid value for ${elementId}: must be a number`);
                }
            }
            
            if (value < min || value > max) {
                element.style.borderColor = '#d4691e';
                throw new Error(`${elementId} must be between ${min} and ${max}`);
            }
            
            element.style.borderColor = '';
            return value;
        }

        function updateTotalTraffic() {
            try {
                const entryRate = parseFloat(document.getElementById('entryRate').value) || 0;
                const exitRate = parseFloat(document.getElementById('exitRate').value) || 0;
                const total = entryRate + exitRate;
                
                document.getElementById('totalTrafficDisplay').textContent = total.toFixed(1);
            } catch (error) {
                document.getElementById('totalTrafficDisplay').textContent = '0.0';
            }
        }

        function validateUtilization() {
            try {
                const entryRate = validateAndParseFloat('entryRate', 0, 1000);
                const exitRate = validateAndParseFloat('exitRate', 0, 1000);
                const entryServiceTime = validateAndParseFloat('entryServiceTime', 0.1, 3600);
                const exitServiceTime = validateAndParseFloat('exitServiceTime', 0.1, 3600);
                
                const totalRate = entryRate + exitRate;
                const avgServiceTime = totalRate > 0 ? 
                    ((entryRate * entryServiceTime) + (exitRate * exitServiceTime)) / totalRate : 0;
                
                const serviceRate = avgServiceTime > 0 ? 3600 / avgServiceTime : Infinity;
                const utilization = totalRate / serviceRate;
                const utilizationPercent = utilization * 100;
                
                const warningDiv = document.getElementById('utilizationWarning');
                const messageSpan = document.getElementById('utilizationMessage');
                const runButton = document.getElementById('runSimulation');
                const utilizationDisplay = document.getElementById('utilizationDisplay');
                
                utilizationDisplay.textContent = totalRate === 0 ? 'N/A' : utilizationPercent.toFixed(1) + '%';
                
                if (totalRate === 0) {
                    warningDiv.style.display = 'none';
                    runButton.disabled = false;
                    runButton.classList.remove('btn-disabled');
                } else if (utilizationPercent >= 100) {
                    warningDiv.style.display = 'block';
                    warningDiv.style.borderColor = '#d4691e';
                    warningDiv.style.background = 'rgba(212, 105, 30, 0.1)';
                    messageSpan.innerHTML = `System overloaded at ${utilizationPercent.toFixed(1)}% utilisation<br><strong>Queues will grow indefinitely</strong>`;
                    runButton.disabled = true;
                    runButton.classList.add('btn-disabled');
                } else if (utilizationPercent >= 95) {
                    warningDiv.style.display = 'block';
                    warningDiv.style.borderColor = '#d4691e';
                    warningDiv.style.background = 'rgba(212, 105, 30, 0.1)';
                    messageSpan.innerHTML = `Very high utilisation at ${utilizationPercent.toFixed(1)}%<br><strong>Expect long queues and delays</strong>`;
                    runButton.disabled = false;
                    runButton.classList.remove('btn-disabled');
                } else if (utilizationPercent >= 80) {
                    warningDiv.style.display = 'block';
                    warningDiv.style.borderColor = '#f39c12';
                    warningDiv.style.background = 'rgba(243, 156, 18, 0.1)';
                    messageSpan.innerHTML = `High utilisation at ${utilizationPercent.toFixed(1)}%<br><strong>Moderate queuing expected</strong>`;
                    runButton.disabled = false;
                    runButton.classList.remove('btn-disabled');
                } else {
                    warningDiv.style.display = 'none';
                    runButton.disabled = false;
                    runButton.classList.remove('btn-disabled');
                }
                
                updateTotalTraffic();
                
            } catch (error) {
                const warningDiv = document.getElementById('utilizationWarning');
                warningDiv.style.display = 'none';
                updateTotalTraffic();
            }
        }

        function updateRuntimeDisplay() {
            try {
                const parameters = collectParameters();
                updateRuntimeEstimateDisplay(parameters);
            } catch (error) {
                console.warn('Could not update runtime display:', error);
            }
        }

        function collectParameters() {
            return {
                entryRate: parseFloat(document.getElementById('entryRate').value),
                exitRate: parseFloat(document.getElementById('exitRate').value),
                entryServiceTime: parseFloat(document.getElementById('entryServiceTime').value),
                exitServiceTime: parseFloat(document.getElementById('exitServiceTime').value),
                entryHeadway: parseFloat(document.getElementById('entryHeadway').value),
                exitHeadway: document.getElementById('exitHeadwayMode').value === 'same' 
                    ? parseFloat(document.getElementById('entryHeadway').value)
                    : parseFloat(document.getElementById('exitHeadway').value),
                simulationHours: parseInt(document.getElementById('simulationHours').value),
                simHours: parseInt(document.getElementById('simulationHours').value),
                numSeeds: parseInt(document.getElementById('numSeeds').value),
                priority: document.getElementById('priority').value,
                seedMode: document.getElementById('seedMode').value
            };
        }

        function calculateSampleSize() {
            try {
                const confidenceLevel = validateAndParseFloat('confidenceLevel');

                const simHours = validateAndParseFloat('simulationHours', 1);
                const entryRate = validateAndParseFloat('entryRate', 0);
                const exitRate = validateAndParseFloat('exitRate', 0);
                const currentSeeds = parseInt(document.getElementById('numSeeds').value) || 15;
                
                const totalTripsPerHour = entryRate + exitRate;
                
                if (totalTripsPerHour === 0) {
                    const resultDiv = document.getElementById('sampleSizeResult');
                    const currentSeedsDisplay = document.getElementById('currentSeedsDisplay');
                    const applyButton = document.getElementById('applySampleSize');
                    
                    if (currentSeedsDisplay) {
                        currentSeedsDisplay.textContent = currentSeeds;
                    }
                    
                    resultDiv.innerHTML = `
                        <strong>Sample size calculation not applicable</strong><br>
                        <small style="color: #999;">Zero traffic rate - no statistical analysis needed</small>
                    `;
                    resultDiv.style.borderColor = '#999';
                    resultDiv.style.background = 'rgba(153, 153, 153, 0.1)';
                    
                    if (applyButton) {
                        applyButton.disabled = true;
                        applyButton.textContent = 'N/A for Zero Rate';
                        applyButton.style.background = '#95a5a6';
                    }
                    return;
                }
                const marginOfError = validateAndParseFloat('marginOfError', 0.001) * totalTripsPerHour / 100;
                
                const zScore = getZScoreForConfidence(confidenceLevel);
                const estimatedStdDev = Math.sqrt(totalTripsPerHour);
                const minSampleSize = Math.ceil(Math.pow((zScore * estimatedStdDev) / marginOfError, 2));
                const adjustedSampleSize = Math.ceil(minSampleSize / simHours);
                recommendedSeeds = Math.max(adjustedSampleSize, 10);
                
                const resultDiv = document.getElementById('sampleSizeResult');
                const currentSeedsDisplay = document.getElementById('currentSeedsDisplay');
                const applyButton = document.getElementById('applySampleSize');
                
                if (currentSeedsDisplay) {
                    currentSeedsDisplay.textContent = currentSeeds;
                }
                
                resultDiv.innerHTML = `
                    <strong>Minimum ${recommendedSeeds} seeds required</strong><br>
                    <small>(${confidenceLevel}% confidence, Z=${zScore.toFixed(3)}, σ=√${totalTripsPerHour}=${estimatedStdDev.toFixed(2)})</small>
                `;
                
                if (applyButton) {
                    if (currentSeeds < recommendedSeeds) {
                        resultDiv.style.borderColor = '#d4691e';
                        resultDiv.style.background = 'rgba(212, 105, 30, 0.1)';
                        resultDiv.innerHTML += '<br><small style="color: #d4691e;">⚠ Currently below recommended seeds.</small>';
                        
                        applyButton.disabled = false;
                        applyButton.textContent = `Use ${recommendedSeeds} Seeds`;
                        applyButton.style.background = '#d4691e';
                    } else if (currentSeeds === recommendedSeeds) {
                        resultDiv.style.borderColor = '#6b99c2';
                        resultDiv.style.background = 'rgba(107, 153, 194, 0.1)';
                        resultDiv.innerHTML += '<br><small style="color: #6b99c2;">✓ Current seeds exactly at minimum</small>';
                        
                        applyButton.disabled = true;
                        applyButton.textContent = 'Already at Minimum';
                        applyButton.style.background = '#95a5a6';
                    } else {
                        resultDiv.style.borderColor = '#6b99c2';
                        resultDiv.style.background = 'rgba(107, 153, 194, 0.1)';
                        resultDiv.innerHTML += '<br><small style="color: #6b99c2;">✓ Current seeds adequate</small>';
                        
                        applyButton.disabled = false;
                        applyButton.textContent = `Use ${recommendedSeeds} Seeds`;
                        applyButton.style.background = '#6b99c2';
                    }
                }
                
            } catch (error) {
                const resultDiv = document.getElementById('sampleSizeResult');
                resultDiv.innerHTML = `<span style="color: #d4691e;">⚠️ ${error.message}</span>`;
                resultDiv.style.borderColor = '#d4691e';
                resultDiv.style.background = 'rgba(212, 105, 30, 0.1)';
            }
        }

        function applySampleSize() {
            if (recommendedSeeds > 0) {
                const numSeedsInput = document.getElementById('numSeeds');
                const oldValue = numSeedsInput.value;
                numSeedsInput.value = recommendedSeeds;
                
                numSeedsInput.classList.add('seeds-updated');
                
                updateRuntimeDisplay();
                calculateSampleSize();
                
                setTimeout(() => {
                    numSeedsInput.classList.remove('seeds-updated');
                }, 2000);
                
                console.log(`Applied sample size: ${oldValue} → ${recommendedSeeds} seeds`);
            }
        }

        function getZScoreForConfidence(confidenceLevel) {
            const zScores = {
                90: 1.645,
                95: 1.96,
                99: 2.576,
                99.9: 3.291,
                99.99: 3.891
            };
            return zScores[confidenceLevel];
        }

        function toggleExitHeadway() {
            const mode = document.getElementById('exitHeadwayMode').value;
            const exitGroup = document.getElementById('exitHeadwayGroup');
            
            if (mode === 'custom') {
                exitGroup.style.display = 'block';
            } else {
                exitGroup.style.display = 'none';
            }
        }

        function resetInputs() {
            document.getElementById('entryRate').value = '15';
            document.getElementById('exitRate').value = '15';
            document.getElementById('entryServiceTime').value = '5.4';
            document.getElementById('exitServiceTime').value = '5.4';
            document.getElementById('entryHeadway').value = '0';
            document.getElementById('exitHeadway').value = '0';
            document.getElementById('exitHeadwayMode').value = 'same';
            document.getElementById('priority').value = 'FCFS';
            document.getElementById('simulationHours').value = '1000';
            document.getElementById('numSeeds').value = '15';
            document.getElementById('confidenceLevel').value = '99.9';
            document.getElementById('marginOfError').value = '0.5';
            document.getElementById('seedMode').value = 'fixed';
            
            document.querySelectorAll('input').forEach(input => {
                input.style.borderColor = '';
            });
            
            toggleExitHeadway();
            
            setTimeout(() => {
                updateTotalTraffic();
                validateUtilization();
                calculateSampleSize();
                updateRuntimeDisplay();
            }, 100);
        }

        function generateValidationCheck(results, params) {
            const expectedEntryRate = params.entryRate;
            const expectedExitRate = params.exitRate;
            const actualEntryRate = results.totalEntries ? (results.totalEntries / params.simulationHours / results.numSeeds) : null;
            const actualExitRate = results.totalExits ? (results.totalExits / params.simulationHours / results.numSeeds) : null;
            const canValidate = actualEntryRate !== null && actualExitRate !== null;
            
            let entryError, exitError, totalError;
            if (canValidate) {
                entryError = Math.abs(actualEntryRate - expectedEntryRate);
                exitError = Math.abs(actualExitRate - expectedExitRate);
                totalError = entryError + exitError;
            }
            
            const marginOfError = parseFloat(document.getElementById('marginOfError').value) || 0.05 * (expectedEntryRate + expectedExitRate) / 100;
            const validationPassed = canValidate ? totalError <= marginOfError : null;
            
            return `
                <h4>${validationPassed === null ? '⚠️' : validationPassed ? '✅' : '❌'} Arrival Rate Validation</h4>
                ${canValidate ? `
                <ul class="validation-list">
                    <li><strong>Expected:</strong> Entry=${expectedEntryRate.toFixed(2)}, Exit=${expectedExitRate.toFixed(2)}</li>
                    <li><strong>Actual:</strong> Entry=${actualEntryRate.toFixed(2)}, Exit=${actualExitRate.toFixed(2)}</li>
                    <li><strong>Error:</strong> ${totalError.toFixed(3)} (Entry=${entryError.toFixed(3)} + Exit=${exitError.toFixed(3)})</li>
                    <li><strong>Status:</strong> ${validationPassed ? 'Rates validated successfully' : 'Rates outside margin'} (±${marginOfError})</li>
                </ul>
                ` : `
                <ul class="validation-list">
                    <li><strong>Expected:</strong> Entry=${expectedEntryRate.toFixed(2)}, Exit=${expectedExitRate.toFixed(2)} cars/hour</li>
                    <li><strong>Note:</strong> Backend validation data not available</li>
                </ul>
                `}
            `;
        }

        function displayResults(results, params) {
            const container = document.getElementById('resultsContent');
            const validationCheck = generateValidationCheck(results, params);
            
            let html = `
                <div class="results-cards-container">
                    <div class="input-summary">
                        <h4>Input Parameters</h4>
                        <div class="input-summary-grid">
                            <div class="input-group">
                                <strong>Model:</strong> Mechanical Parking Structure
                            </div>
                            <div class="input-group">
                                <strong>Entry Rate:</strong> ${params.entryRate} cars/hr
                            </div>
                            <div class="input-group">
                                <strong>Exit Rate:</strong> ${params.exitRate} cars/hr
                            </div>
                            <div class="input-group">
                                <strong>Entry Service:</strong> ${params.entryServiceTime}s
                            </div>
                            <div class="input-group">
                                <strong>Exit Service:</strong> ${params.exitServiceTime}s
                            </div>
                            <div class="input-group">
                                <strong>Priority Mode:</strong> ${params.priority}
                            </div>
                            <div class="input-group">
                                <strong>Simulation:</strong> ${params.simulationHours}h × ${params.numSeeds} seeds
                            </div>
                        </div>
                    </div>
                    
                    <div class="results-card">
                        ${validationCheck}
                    </div>
                </div>
                
                <div class="utilisation-checkpoint">
                    Structure Utilisation: ${(results.utilisation * 100).toFixed(2)}%
                </div>
                
                <div class="tables-container" style="grid-template-columns: 1fr 1fr;">
                    <div class="table-section" style="padding: 8px;">
                        <h4 style="color: #354e8d; margin-bottom: 8px; font-size: 1rem; font-weight: 600; text-align: center;">Performance Metrics</h4>
                        <table class="metrics-table">
                            <thead>
                                <tr>
                                    <th>Operation</th>
                                    <th>Wait Time (s)</th>
                                    <th>Delay Probability</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="text-align: left; font-weight: 600;">Entry</td>
                                    <td>${results.avgWaitEntryArrival.toFixed(2)}</td>
                                    <td>${(results.delayEntry * 100).toFixed(2)}%</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; font-weight: 600;">Exit</td>
                                    <td>${results.avgWaitExitArrival.toFixed(2)}</td>
                                    <td>${(results.delayExit * 100).toFixed(2)}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="table-section" style="padding: 8px;">
                        <h4 style="color: #354e8d; margin-bottom: 8px; font-size: 1rem; font-weight: 600; text-align: center;">Wait Time Statistics</h4>
                        <table class="metrics-table">
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Entry</th>
                                    <th>Exit</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="text-align: left; font-weight: 600;">Per Arrival</td>
                                    <td>${results.avgWaitEntryArrival.toFixed(2)}s</td>
                                    <td>${results.avgWaitExitArrival.toFixed(2)}s</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; font-weight: 600;">Per Queued</td>
                                    <td>${results.avgWaitEntryQueued.toFixed(2)}s</td>
                                    <td>${results.avgWaitExitQueued.toFixed(2)}s</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tables-container">
                    <div class="table-section">
                        <h4>Entry Queue Analysis</h4>
                        <div class="table-content">
                            <div class="distribution-table-container">
                                <table class="distribution-table">
                                    <thead>
                                        <tr>
                                            <th>Queue Length</th>
                                            <th>% Time</th>
                                            <th>Cum. % Time</th>
                                            <th>% Hours Max</th>
                                            <th>Cum. % Hours Max</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            const entryKeys = Object.keys(results.entryHist).map(k => parseInt(k)).sort((a, b) => a - b).slice(0, 10);
            let entryCumTime = 0;
            let entryCumMax = 0;
            
            for (const length of entryKeys) {
                const timePercent = results.entryHist[length] || 0;
                const maxPercent = results.entryMaxHist[length] || 0;
                
                entryCumTime += timePercent;
                entryCumMax += maxPercent;
                
                if (timePercent > 0.01 || maxPercent > 0.01) {
                    html += `
                        <tr>
                            <td>${length}</td>
                            <td>${timePercent.toFixed(2)}%</td>
                            <td>${entryCumTime.toFixed(2)}%</td>
                            <td>${maxPercent.toFixed(2)}%</td>
                            <td>${entryCumMax.toFixed(2)}%</td>
                        </tr>
                    `;
                }
            }
            
            html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-section">
                        <h4>Exit Queue Analysis</h4>
                        <div class="table-content">
                            <div class="distribution-table-container">
                                <table class="distribution-table">
                                    <thead>
                                        <tr>
                                            <th>Queue Length</th>
                                            <th>% Time</th>
                                            <th>Cum. % Time</th>
                                            <th>% Hours Max</th>
                                            <th>Cum. % Hours Max</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            const exitKeys = Object.keys(results.exitHist).map(k => parseInt(k)).sort((a, b) => a - b).slice(0, 10);
            let exitCumTime = 0;
            let exitCumMax = 0;
            
            for (const length of exitKeys) {
                const timePercent = results.exitHist[length] || 0;
                const maxPercent = results.exitMaxHist[length] || 0;
                
                exitCumTime += timePercent;
                exitCumMax += maxPercent;
                
                if (timePercent > 0.01 || maxPercent > 0.01) {
                    html += `
                        <tr>
                            <td>${length}</td>
                            <td>${timePercent.toFixed(2)}%</td>
                            <td>${exitCumTime.toFixed(2)}%</td>
                            <td>${maxPercent.toFixed(2)}%</td>
                            <td>${exitCumMax.toFixed(2)}%</td>
                        </tr>
                    `;
                }
            }
            
            html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        document.getElementById('resetButton').addEventListener('click', resetInputs);

        document.getElementById('runSimulation').addEventListener('click', async () => {
            const token = localStorage.getItem('authToken');
            if (!token || !isValidToken(token)) {
                window.location.href = '/login/';
                return;
            }

            const runButton = document.getElementById('runSimulation');
            if (runButton.disabled) return;

            let parameters;
            try {
                parameters = collectParameters();
            } catch (error) {
                return;
            }

            const estimatedMs = estimateSimulationRuntime(parameters);
            const estimatedTimeStr = formatEstimatedTime(estimatedMs);
            const numSeeds = parameters.numSeeds;

            const elements = {
                status: document.getElementById('status'),
                progressContainer: document.getElementById('progressContainer'),
                progressFill: document.getElementById('progressFill'),
                progressPercentage: document.getElementById('progressPercentage'),
                progressDetails: document.getElementById('progressDetails'),
                resultsContent: document.getElementById('resultsContent')
            };

            runButton.disabled = true;
            runButton.textContent = `Running simulation...`;
            elements.status.style.display = 'block';
            elements.status.className = 'status running';
            elements.status.textContent = `Running simulation...`;
            elements.progressContainer.style.display = 'block';
            elements.resultsContent.innerHTML = `<div class="no-results"><h4>Running simulation...</h4><p>Processing ${numSeeds} seeds</p></div>`;

            scrollToProgress();

            const progressInterval = createRealisticProgress(estimatedMs, elements.progressFill, elements.progressPercentage, elements.progressDetails);
            const startTime = Date.now();

            try {
                            const apiUrl = window.API_CONFIG?.endpoints?.['mechanical'] || 'https://4x66k1lppi.execute-api.us-east-1.amazonaws.com/api/mechanical';
const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ action: 'runParkingSimulation', parameters })
                });

                clearInterval(progressInterval);

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login/';
                    return;
                }

                if (!response.headers.get('content-type')?.includes('application/json')) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Simulation failed');

                const actualTime = Date.now() - startTime;
                const serverTime = data.executionTimeMs || actualTime;

                elements.progressFill.style.width = '100%';
                elements.progressPercentage.textContent = '100%';
                elements.progressDetails.textContent = `Complete! (${(serverTime/1000).toFixed(2)}s)`;
                elements.status.className = 'status complete';
                elements.status.textContent = `Completed in ${(serverTime/1000).toFixed(2)}s`;

                // Explicitly track usage (automatic tracking via fetch wrapper should also fire)
                if (window.recordSimulationUsage) {
                    window.recordSimulationUsage('mechanical', parameters, startTime, true);
                }

                displayResults(data.results, parameters);

                setTimeout(() => {
                    scrollToResults();
                }, 300);

                setTimeout(() => {
                    elements.status.style.display = 'none';
                    elements.progressContainer.style.display = 'none';
                }, 4000);

            } catch (error) {
                clearInterval(progressInterval);
                elements.status.className = 'status error';
                elements.status.textContent = 'Error: ' + error.message;
                elements.resultsContent.innerHTML = `<div class="no-results"><h4>Error</h4><p>${error.message}</p></div>`;
                
                setTimeout(() => {
                    scrollToResults();
                }, 300);
            }

            runButton.disabled = false;
            runButton.textContent = 'Run Simulation';
        });
    </script>
</body>
</html>